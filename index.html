<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wild Guess - Live Research Grade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <style>
        /* CHANGED: 'display=block' hides the text until the font loads, preventing the ugly flash */
        @import url('https://fonts.googleapis.com/css2?family=Freckle+Face&display=block');
        body { font-family: 'Rubik', sans-serif; background-color: #f0fdf4; overscroll-behavior: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.3s ease-out; }

        @keyframes swap {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .swap-anim { animation: swap 0.15s ease-in-out; }

        /* Add this to your <style> block */
        #landscape-warning { display: none; }
        
        /* Triggers only on devices that are short (like a phone in landscape) */
        @media screen and (max-height: 500px) and (orientation: landscape) {
            #landscape-warning { display: flex !important; }
        }



        /* Custom Sticker Classes */
        .font-freckle { font-family: 'Freckle Face', cursive; }
        
        /* 1. TITLE STICKER: Super thick stroke for text */
        .sticker-text {
            -webkit-text-stroke: 8px white;
            paint-order: stroke fill;
            /* Fallback shadow for browsers that don't support stroke well */
            text-shadow: 4px 4px 0px rgba(0,0,0,0.2);
        }

        /* 2. EMOJI STICKER: Chained drop-shadows create a thick solid outline */
        .emoji-sticker {
            filter: 
                drop-shadow(0px 2px 0px white) 
                drop-shadow(0px -2px 0px white) 
                drop-shadow(2px 0px 0px white) 
                drop-shadow(-2px 0px 0px white)
                drop-shadow(0px 2px 0px white) 
                drop-shadow(0px -2px 0px white) 
                drop-shadow(2px 0px 0px white) 
                drop-shadow(-2px 0px 0px white)
                drop-shadow(3px 3px 5px rgba(0,0,0,0.3)); /* The actual shadow */
        }

        .leaflet-container { height: 100%; width: 100%; border-radius: 0.5rem; z-index: 0; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }


        .custom-pin {
            background-color: #ef4444;
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 3px solid white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        const ANIMAL_GROUPS = [
            // --- CARNIVORES ---
            {
                emoji: "ðŸº", name: "Canines",
                animals: [
                    // Dingo: Hidden as 'Canis familiaris' (Domestic Dog variant)
                    { name: "Wolf", sciName: "Canis lupus", family: "Canidae", clue: "Pack hunter whose howl defines the wilderness; ancestor of the domestic dog." },
                    { name: "Coyote", sciName: "Canis latrans", family: "Canidae", clue: "Adaptable trickster of folklore; known for yipping at the moon." },
                    { name: "Fox", sciName: "Vulpes vulpes", family: "Canidae", clue: "Cunning, bushy-tailed omnivore that hunts with a characteristic pounce." },
                    { name: "Dingo", sciName: "Canis lupus dingo", displayLatin: "Canis familiaris (var.)", family: "Canidae", clue: "Apex predator of the Australian outback; rarely barks." },
                    { name: "Wild Dog", sciName: "Lycaon pictus", family: "Canidae", clue: "Mottled African hunter with rounded ears; lives in close-knit packs." },
                    { name: "Jackal", sciName: "Canis aureus", family: "Canidae", clue: "Scavenger of the savanna; often associated with Anubis in myth." }
                ]
            },
            {
                emoji: "ðŸ¦", name: "Felines",
                animals: [
                    // Lion/Tiger: Used 'Felis' (Old Linnaeus classification) to hide 'Panthera'
                    { name: "Lion", sciName: "Panthera leo", displayLatin: "Felis leo", family: "Felidae", clue: "Only social cat; males sport a regal ruff of hair." },
                    { name: "Tiger", sciName: "Panthera tigris", displayLatin: "Felis tigris", family: "Felidae", clue: "Striped ambush predator; swims well and rules the Asian jungles." },
                    { name: "Cheetah", sciName: "Acinonyx jubatus", family: "Felidae", clue: "Sprint specialist with non-retractable claws; hunts by day." },
                    { name: "Jaguar", sciName: "Panthera onca", family: "Felidae", clue: "New World cat with a bite strong enough to crack turtle shells." },
                    { name: "Snow Leopard", sciName: "Panthera uncia", family: "Felidae", clue: "Ghost of the mountains; uses a massive tail for balance on cliffs." },
                    { name: "Cougar", sciName: "Puma concolor", family: "Felidae", clue: "Mountain dweller with the most names of any animal; screams like a human." }
                ]
            },
            {
                emoji: "ðŸ»", name: "Bears",
                animals: [
                    { name: "Bear (Brown)", sciName: "Ursus arctos", family: "Ursidae", clue: "Massive omnivore with a shoulder hump; fishes during salmon runs." },
                    { name: "Bear (Polar)", sciName: "Ursus maritimus", family: "Ursidae", clue: "Marine predator of the ice; skin is black, but fur appears white." },
                    { name: "Panda", sciName: "Ailuropoda melanoleuca", family: "Ursidae", clue: "Bamboo specialist with a modified wrist bone acting as a thumb." },
                    { name: "Bear (Black)", sciName: "Ursus americanus", family: "Ursidae", clue: "Forest climber of North America; despite the name, can be cinnamon colored." },
                    { name: "Bear (Sun)", sciName: "Helarctos malayanus", family: "Ursidae", clue: "Smallest of its kind; arboreal with a golden chest crescent." }
                ]
            },
            {
                emoji: "ðŸ¦¡", name: "Weasels & Badgers", 
                animals: [
                    { name: "Wolverine", sciName: "Gulo gulo", family: "Mustelidae", clue: "Ferocious glutton of the north; known to fight off bears for food." },
                    { name: "Badger", sciName: "Meles meles", family: "Mustelidae", clue: "Distinctive striped face; lives in extensive underground setts." },
                    { name: "Otter", sciName: "Lutra lutra", family: "Mustelidae", clue: "Semi-aquatic acrobat; hunts fish and plays on riverbanks." },
                    { name: "Honey Badger", sciName: "Mellivora capensis", family: "Mustelidae", clue: "Thick-skinned warrior; famous for raiding beehives and fearing nothing." },
                    { name: "Stoat", sciName: "Mustela erminea", family: "Mustelidae", clue: "Small predator that turns white in winter (ermine) to hunt in snow." },
                    { name: "Ferret (Black-footed)", sciName: "Mustela nigripes", family: "Mustelidae", clue: "Highly endangered prairie dweller; relies almost entirely on prairie dogs." }
                ]
            },

            // --- PRIMATES & ODDITIES ---
            {
                emoji: "ðŸ’", name: "Primates",
                animals: [
                    // Gorilla: Swapped to synonym 'Troglodytes' (Cave dweller). 
                    // Mandrill: Swapped to synonym 'Simia' (Ape).
                    // Lemur: Swapped Family to 'Strepsirrhini' (Wet-nosed primates).
                    { name: "Gorilla", sciName: "Gorilla", displayLatin: "Troglodytes gorilla", family: "Hominidae", clue: "Gentle giant of the jungle; silverbacks lead the troop." },
                    { name: "Chimpanzee", sciName: "Pan troglodytes", family: "Hominidae", clue: "Tool-using ape; shares nearly 99% of DNA with humans." },
                    { name: "Orangutan", sciName: "Pongo", family: "Hominidae", clue: "Solitary 'Person of the Forest'; rare red ape of Sumatra/Borneo." },
                    { name: "Lemur", sciName: "Lemur catta", displayLatin: "Prosimii catta", family: "Suborder: Strepsirrhini", clue: "Prosimian endemic to one island; famous for its ghostly stare and striped tail." },
                    { name: "Baboon", sciName: "Papio anubis", family: "Cercopithecidae", clue: "Ground-dweller with a dog-like muzzle and formidable canines." },
                    { name: "Mandrill", sciName: "Mandrillus sphinx", displayLatin: "Simia sphinx", family: "Cercopithecidae", clue: "World's largest monkey; features a vibrant red and blue face." }
                ]
            },
            {
                emoji: "ðŸ”®", name: "Unique Mammals", 
                animals: [
                    // Wombat: Changed Vombatidae -> Diprotodontia (Order)
                    // Tapir: Changed Tapiridae -> Perissodactyla (Order)
                    { name: "Platypus", sciName: "Ornithorhynchus anatinus", family: "Ornithorhynchidae", clue: "Bio-fluorescent monotreme; looks like a beaver built by a duck." },
                    { name: "Sloth", sciName: "Bradypus variegatus", family: "Bradypodidae", clue: "Host to algae in its fur; so slow it descends only once a week." },
                    { name: "Armadillo", sciName: "Dasypus novemcinctus", family: "Dasypodidae", clue: "Leathery tank of the Americas; the only mammal with a shell." },
                    { name: "Bat", sciName: "Tadarida brasiliensis", family: "Molossidae", clue: "Only mammal capable of true flight; navigates via echolocation." },
                    { name: "Beaver", sciName: "Castor fiber", family: "Castoridae", clue: "Nature's engineer; fells trees to create its own aquatic habitat." }, 
                    { name: "Capybara", sciName: "Hydrochoerus hydrochaeris", family: "Caviidae", clue: "Giant riparian grazer; the world's largest living rodent." } 
                ]
            },

            // --- HERBIVORES ---
            {
                emoji: "ðŸ˜", name: "Savanna Giants", 
                animals: [
                    // Giraffe: Giraffa -> Cervus camelopardalis (Old name "Camel-Leopard-Deer")
                    // Elephant: Elephantidae -> Proboscidea (Order)
                    // Hippo: Hippopotamidae -> Whippomorpha (Suborder)
                    // Rhino: Rhinocerotidae -> Perissodactyla (Order)
                    { name: "Giraffe", sciName: "Giraffa", displayLatin: "Cervus camelopardalis", family: "Order: Artiodactyla", clue: "Browser of treetops; born with horns and a purple tongue." },
                    { name: "Zebra", sciName: "Equus quagga", family: "Equidae", clue: "Savanna grazer; no two individuals share the same stripe pattern." },
                    { name: "Elephant", sciName: "Loxodonta africana", family: "Order: Proboscidea", clue: "Intelligent matriarchal giant; communicates via subsonic rumbles." },
                    { name: "Hippo", sciName: "Hippopotamus amphibius", displayLatin: "H. amphibius", family: "Suborder: Whippomorpha", clue: "River titan that secretes 'blood sweat'; territorial and dangerous." },
                    { name: "Rhino", sciName: "Ceratotherium simum", family: "Order: Perissodactyla", clue: "Armored tank of the bush; hunted for its keratin horn." }
                ]
            },
            {
                emoji: "ðŸŒ²", name: "Forest Grazers", 
                animals: [
                    // Bison: Bison bison -> Bos americanus (Synonym)
                    // Okapi: Okapia -> O. johnstoni (Hiding genus)
                    { name: "Moose", sciName: "Alces alces", family: "Cervidae", clue: "Solitary northern giant; dives underwater to eat aquatic plants." },
                    { name: "Deer (Red)", sciName: "Cervus elaphus", family: "Cervidae", clue: "Antlered forest dweller; males rut in autumn to secure mates." },
                    { name: "Elk", sciName: "Cervus canadensis", family: "Cervidae", clue: "Loud bugler of the Rockies; one of the largest deer species." },
                    { name: "Bison", sciName: "Bison bison", displayLatin: "Bos americanus", family: "Bovidae", clue: "Woolly tank of the plains; the largest land mammal in North America." },
                    { name: "Tapir", sciName: "Tapirus terrestris", family: "Order: Perissodactyla", clue: "Prehensile-nosed jungle dweller; looks like a pig but related to horses." },
                    { name: "Okapi", sciName: "Okapia johnstoni", displayLatin: "O. johnstoni", family: "Giraffidae", clue: "The forest giraffe; has zebra-like stripes on its legs." }
                ]
            },
            {
                emoji: "ðŸ¦Œ", name: "Antelopes",
                animals: [
                    // Oryx: Oryx gazella -> O. gazella
                    { name: "Wildebeest", sciName: "Connochaetes taurinus", family: "Bovidae", clue: "The 'Gnu'; crosses rivers in massive herds during the Great Migration." },
                    { name: "Impala", sciName: "Aepyceros melampus", family: "Bovidae", clue: "McDonald's of the Bush; known for distinct black heel markings." },
                    { name: "Gazelle", sciName: "Eudorcas thomsonii", family: "Bovidae", clue: "Delicate sprinter; performs 'stotting' jumps to signal fitness." },
                    { name: "Oryx", sciName: "Oryx gazella", displayLatin: "O. gazella", family: "Bovidae", clue: "Desert survivor; wields straight, rapier-like horns." },
                    { name: "Kudu", sciName: "Tragelaphus strepsiceros", family: "Bovidae", clue: "Grey ghost of the bush; males bear magnificent corkscrew horns." },
                    { name: "Springbok", sciName: "Antidorcas marsupialis", family: "Bovidae", clue: "National symbol of South Africa; famous for its pronking displays." }
                ]
            },
            {
                emoji: "ðŸ­", name: "Small Mammals", 
                animals: [
                    // Wombat: Vombatidae -> Diprotodontia (Order)
                    { name: "Mouse", sciName: "Mus musculus", family: "Muridae", clue: "Tiny commensal squeaker; likely the most numerous mammal in human homes." },
                    { name: "Chipmunk", sciName: "Tamias striatus", family: "Sciuridae", clue: "Striped hoarder of the forest floor; famous for stuffing its cheeks with food." },
                    { name: "Squirrel", sciName: "Sciurus vulgaris", family: "Sciuridae", clue: "Bushy-tailed hoarder; plays a key role in planting forests by forgetting nuts." },
                    { name: "Rabbit", sciName: "Oryctolagus cuniculus", family: "Leporidae", clue: "Long-eared hopper; lives in warrens and breeds proverbially fast." },
                    { name: "Hedgehog", sciName: "Erinaceus europaeus", family: "Erinaceidae", clue: "Nocturnal insectivore; rolls into a prickly ball when threatened." },
                    { name: "Raccoon", sciName: "Procyon lotor", family: "Procyonidae", clue: "Masked bandit of the trash can; washes food with dexterous paws." },      
                    { name: "Skunk", sciName: "Mephitis mephitis", family: "Mephitidae", clue: "Boldly striped and slow-moving; armed with a chemical weapon." }, 
                    { name: "Meerkat", sciName: "Suricata suricatta", family: "Herpestidae", clue: "Social desert dweller; stands upright on sentry duty." },
                    { name: "Wombat", sciName: "Vombatus ursinus", family: "Order: Diprotodontia", clue: "Cube-pooping burrower; uses a reinforced rump for defense." }
                ]
            },
            {
                emoji: "ðŸ¦˜", name: "Marsupials",
                animals: [
                    { name: "Kangaroo", sciName: "Macropus rufus", family: "Macropodidae", clue: "The 'Big Red'; boxes rivals and carries young in a pouch." },
                    { name: "Koala", sciName: "Phascolarctos cinereus", family: "Phascolarctidae", clue: "Sleepy eucalyptus specialist; possess fingerprints like humans." },
                    { name: "Sugar Glider", sciName: "Petaurus breviceps", family: "Petauridae", clue: "Small nocturnal arboreal; uses a membrane to soar between trees." }, 
                    { name: "Opossum", sciName: "Didelphis virginiana", family: "Didelphidae", clue: "New World marsupial; famous for feigning death." }
                ]
            },

            // --- BIRDS ---
            {
                emoji: "ðŸ¦…", name: "Raptors",
                animals: [
                    // Falcon: Falconidae -> Falconiformes
                    { name: "Eagle", sciName: "Haliaeetus leucocephalus", family: "Accipitridae", clue: "Apex predator of the sky; symbol of freedom in the west." },
                    { name: "Owl", sciName: "Tyto alba", family: "Tytonidae", clue: "Silent night flyer; can rotate its head 270 degrees." },
                    { name: "Hawk", sciName: "Buteo jamaicensis", family: "Accipitridae", clue: "Broad-winged soarer; its scream is often dubbed over eagle footage." },
                    { name: "Falcon", sciName: "Falco peregrinus", family: "Order: Falconiformes", clue: "Aerodynamic diver; the fastest member of the animal kingdom." },
                    { name: "Vulture", sciName: "Cathartes aura", family: "Cathartidae", clue: "Bald-headed recycler; cleans the environment by eating the dead." },
                    { name: "Osprey", sciName: "Pandion haliaetus", family: "Pandionidae", clue: "Specialized angler; carries fish aerodynamically with reversible toes." }
                ]
            },
            {
                emoji: "ðŸ¦†", name: "Water Birds",
                animals: [
                    { name: "Penguin", sciName: "Aptenodytes forsteri", family: "Spheniscidae", clue: "Flightless tuxedo wearer; endures the harshest winter on Earth." },
                    { name: "Pelican", sciName: "Pelecanus occidentalis", family: "Pelecanidae", clue: "Coastal fisher; its beak holds more than its belly." },
                    { name: "Swan", sciName: "Cygnus olor", family: "Anatidae", clue: "Symbol of grace; monogamous waterfowl with a powerful wing strike." },
                    { name: "Flamingo", sciName: "Phoenicopterus roseus", family: "Phoenicopteridae", clue: "Filter feeder; turns pink from the carotenoids in its diet." },
                    { name: "Stork", sciName: "Ciconia ciconia", family: "Ciconiidae", clue: "Leggy wader; mythologically associated with delivering babies." },
                    { name: "Duck", sciName: "Anas platyrhynchos", family: "Anatidae", clue: "Dabbling swimmer; males often sport an iridescent green head." }
                ]
            },
            {
                emoji: "ðŸ¦œ", name: "Exotic Birds",
                animals: [
                    // Macaw: Ara -> Arini (Tribe)
                    { name: "Macaw", sciName: "Ara macao", displayLatin: "Tribe: Arini", family: "Psittacidae", clue: "Vibrant rainforest loudmouth; cracks nuts with a powerful beak." },
                    { name: "Toucan", sciName: "Ramphastos toco", family: "Ramphastidae", clue: "Frugivore with a bill that looks too large for its body." },
                    { name: "Peacock", sciName: "Pavo cristatus", family: "Phasianidae", clue: "Ground bird; male performs a dazzling 'eyed' fan dance." },
                    { name: "Hummingbird", sciName: "Archilochus colubris", family: "Trochilidae", clue: "Nectar sipper; the only bird capable of flying backwards." },
                    { name: "Parrot", sciName: "Psittacus erithacus", family: "Psittacidae", clue: "Grey intellectual; capable of mimicking human speech with context." },
                    { name: "Ibis", sciName: "Eudocimus ruber", family: "Threskiornithidae", clue: "Brilliant red wading bird found in wetlands." }
                ]
            },
            {
                emoji: "ðŸ¦", name: "Songbirds", 
                animals: [
                    { name: "Robin", sciName: "Erithacus rubecula", family: "Muscicapidae", clue: "Herald of spring; aggressive defender of its garden territory." },
                    { name: "Blue Jay", sciName: "Cyanocitta cristata", family: "Corvidae", clue: "Crested corvid; noisy mimic known for mobbing hawks." },
                    { name: "Sparrow", sciName: "Passer domesticus", family: "Passeridae", clue: "Urban survivor; ubiquitous brown bird that chirps in hedges." },
                    { name: "Crow", sciName: "Corvus corone", family: "Corvidae", clue: "All-black problem solver; recognizes individual human faces." },
                    { name: "Pigeon", sciName: "Columba livia", family: "Columbidae", clue: "Cliff-dwelling dove adapted to city skyscrapers; creates 'milk' for young." },
                    { name: "Cardinal", sciName: "Cardinalis cardinalis", family: "Cardinalidae", clue: "Brilliant red songbird; angry looking, but distinct whistle." }
                ]
            },
            {
                emoji: "ðŸ¦ƒ", name: "Ground Birds", 
                animals: [
                    { name: "Ostrich", sciName: "Struthio camelus", family: "Struthionidae", clue: "Flightless titan; lays the largest egg of any living animal." },
                    { name: "Emu", sciName: "Dromaius novaehollandiae", family: "Dromaiidae", clue: "Australia's runner; survives the outback and won a war against humans." },
                    { name: "Cassowary", sciName: "Casuarius casuarius", family: "Casuariidae", clue: "The 'murder bird'; wears a helmet and wields a dagger-like toe." },
                    { name: "Turkey", sciName: "Meleagris gallopavo", family: "Phasianidae", clue: "Wattled forest dweller; Ben Franklin preferred it over the Eagle." },
                    { name: "Roadrunner", sciName: "Geococcyx californianus", family: "Cuculidae", clue: "Desert sprinter; famous for eating rattlesnakes and outsmarting coyotes." },
                    { name: "Kiwi", sciName: "Apteryx mantelli", family: "Apterygidae", clue: "New Zealand's icon; flightless, nocturnal, and whiskers like a cat." }
                ]
            },

            // --- REPTILES & AQUATIC ---
            {
                emoji: "ðŸŠ", name: "Reptiles",
                animals: [
                    // Croc/Iguana/Komodo/Boa/Chameleon: All obscured using Clades/Synonyms
                    { name: "Crocodile", sciName: "Crocodylus niloticus", displayLatin: "C. niloticus", family: "Clade: Eusuchia", clue: "Prehistoric ambush predator; has a V-shaped snout and toothy grin." },
                    { name: "Cobra", sciName: "Ophiophagus hannah", family: "Elapidae", clue: "Hooded serpent; rises up to display a spectacle pattern." },
                    { name: "Tortoise", sciName: "Chelonoidis", family: "Testudinidae", clue: "Armored grazer; can live well over 100 years." },
                    { name: "Iguana", sciName: "Iguana iguana", displayLatin: "Iguanidae (Type Sp.)", family: "Clade: Pleurodonta", clue: "Spiny arboreal lizard; sneezes salt and drops from trees when cold." },
                    { name: "Komodo Dragon", sciName: "Varanus komodoensis", displayLatin: "Varanus (Giant)", family: "Varanidae", clue: "Island giant; hunts with bacteria-laden saliva and venom." },
                    { name: "Boa", sciName: "Boa constrictor", displayLatin: "Constrictor constrictor", family: "Boidae", clue: "New World constrictor; gives birth to live young." },
                    { name: "Chameleon", sciName: "Furcifer pardalis", family: "Chamaeleonidae", clue: "Zygodactyl climber; changes color for mood, not just camouflage." }
                ]
            },
            {
                emoji: "ðŸ¸", name: "Amphibians",
                animals: [
                    // Salamandra -> Urodela (Order)
                    { name: "Bullfrog", sciName: "Lithobates catesbeianus", family: "Ranidae", clue: "Voracious eater; anything that fits in its mouth is food." },
                    { name: "Toad", sciName: "Bufo bufo", family: "Bufonidae", clue: "Warty walker; produces bufotoxin to deter predators." },
                    { name: "Salamandra", sciName: "Salamandra salamandra", displayLatin: "Order: Urodela", family: "Salamandridae", clue: "Fire lizard of legend; warns predators with yellow spots." },
                    { name: "Axolotl", sciName: "Ambystoma mexicanum", family: "Ambystomatidae", clue: "The 'Walking Fish'; stays in its larval form forever." },
                    { name: "Frog (Tree)", sciName: "Agalychnis callidryas", family: "Hylidae", clue: "Sticky-toed climber; famous for bright green skin and red eyes." }
                ]
            },
            {
                emoji: "ðŸ¬", name: "Marine",
                animals: [
                    // Octopus: Octopus -> Octopoda
                    { name: "Whale", sciName: "Balaenoptera musculus", family: "Balaenopteridae", clue: "Gentle giant; heart is the size of a small car." },
                    { name: "Dolphin", sciName: "Tursiops", family: "Delphinidae", clue: "Playful cetacean; uses distinct whistles to identify friends." },
                    { name: "Shark", sciName: "Carcharodon carcharias", family: "Lamnidae", clue: "Cartilaginous predator; can sense electricity in the water." },
                    { name: "Octopus", sciName: "Octopus vulgaris", displayLatin: "Octopoda (Common)", family: "Octopodidae", clue: "Master of disguise; has three hearts and blue blood." },
                    { name: "Seal", sciName: "Phoca vitulina", family: "Phocidae", clue: "Pinniped 'sea dog'; hauls out on rocks to rest." },
                    { name: "Crab", sciName: "Callinectes sapidus", family: "Portunidae", clue: "Decapod scavenger; walks sideways and wields pincers." }
                ]
            },
            {
                emoji: "ðŸ ", name: "Fish",
                animals: [
                    // Salmon: Salmonidae -> Salmoniformes
                    { name: "Goldfish", sciName: "Carassius auratus", family: "Cyprinidae", clue: "Carp descendant; selectively bred for centuries for color." },
                    { name: "Salmon", sciName: "Salmo salar", displayLatin: "S. salar", family: "Order: Salmoniformes", clue: "The Leaper; returns to its natal stream to spawn and die." },
                    { name: "Clownfish", sciName: "Amphiprion ocellaris", family: "Pomacentridae", clue: "Anemone dweller; immune to the stings of its host." },
                    { name: "Seahorse", sciName: "Hippocampus guttulatus", family: "Syngnathidae", clue: "Upright swimmer; the male carries the pregnancy." },
                    { name: "Piranha", sciName: "Pygocentrus nattereri", family: "Serrasalmidae", clue: "Amazonian shoaler; possesses interlocking teeth and a scary reputation." }
                ]
            },
            {
                emoji: "ðŸ¦‹", name: "Insects+",
                animals: [
                    // Mantis: Mantis -> Dictyoptera
                    { name: "Butterfly", sciName: "Danaus plexippus", family: "Nymphalidae", clue: "Migratory marvel; tastes with its feet and originated as a caterpillar." },
                    { name: "Bee", sciName: "Apis mellifera", family: "Apidae", clue: "Important pollinator that lives in hives and produces wax." },
                    { name: "Tarantula", sciName: "Brachypelma", family: "Theraphosidae", clue: "Hairy arachnid; flicks urticating bristles when threatened." },
                    { name: "Scorpion", sciName: "Pandinus imperator", family: "Scorpionidae", clue: "Fluorescent arachnid; carries a stinger on a segmented tail." },
                    { name: "Snail", sciName: "Cornu aspersum", family: "Helicidae", clue: "Hermaphroditic grazer; carries its calcium house on its back." },
                    { name: "Mantis", sciName: "Mantis religiosa", displayLatin: "Order: Mantodea", family: "Mantidae", clue: "Patient ambush predator; famous for sexual cannibalism." }
                ]
            }
        ];

        // --- HELPER: Flatten & Sort for "All Animals" ---
        const ALL_ANIMALS_FLAT = ANIMAL_GROUPS.reduce((acc, group) => {
            return acc.concat(group.animals.map(a => ({...a, group: group.name, groupEmoji: group.emoji})));
        }, []).sort((a, b) => a.name.localeCompare(b.name));

        // --- COMPONENT: MapClue (Updated for Dynamic Zoom) ---
        const MapClue = ({ lat, lng, zoom }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const resizeObserverRef = useRef(null);

            useEffect(() => {
                if (mapRef.current && !mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, {
                        zoomControl: false, attributionControl: false, dragging: false,
                        scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false, 
                    }).setView([lat, lng], zoom);

                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap &copy; CARTO',
                        maxZoom: 19
                    }).addTo(mapInstanceRef.current);

                    const icon = L.divIcon({
                        className: 'custom-pin', html: `<div></div>`,
                        iconSize: [20, 20], iconAnchor: [10, 10]
                    });

                    markerRef.current = L.marker([lat, lng], { icon }).addTo(mapInstanceRef.current);

                    resizeObserverRef.current = new ResizeObserver(() => {
                       if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                   });
                    resizeObserverRef.current.observe(mapRef.current);
                }
                return () => {
                    if (resizeObserverRef.current) resizeObserverRef.current.disconnect();
                };
            }, []);

            // React to props updates (Zooming in)
            useEffect(() => {
                if (mapInstanceRef.current && markerRef.current) {
                    mapInstanceRef.current.setView([lat, lng], zoom);
                    markerRef.current.setLatLng([lat, lng]);
                }
            }, [lat, lng, zoom]);

            return <div ref={mapRef} className="w-full h-full"></div>;
        };

        // --- HELPER: Filter Low Quality Records (Updated) ---
        const isLowQualityRecord = (record) => {
            // 1. CHECK OFFICIAL ANNOTATIONS (The most accurate source)
            // iNat Attribute 22 = "Evidence of Presence"
            // Values: 24=Track, 25=Scat, 26=Molt, 27=Bone, 23=Feather, 31=Egg, 28=Organism
            if (record.annotations && record.annotations.length > 0) {
                for (const note of record.annotations) {
                    // Check "Evidence of Presence" (ID 22)
                    if (note.attribute_id === 22) {
                        // If the value is NOT 28 (Organism), it's likely a trace (scat, track, etc.)
                        if (note.value_id !== 28) return true; 
                    }
                    // Check "Alive or Dead" (ID 9) -> Value 10 is "Dead"
                    if (note.attribute_id === 9 && note.value_id === 10) return true;
                }
            }

            // 2. Strict JSON/Property Checks (Legacy/Backup)
            const dynProps = (record.dynamicProperties || "").toLowerCase().replace(/\s/g, "");
            if (dynProps.includes('"evidenceofpresence":"track"')) return true;
            if (dynProps.includes('"evidenceofpresence":"scat"')) return true;
            if (dynProps.includes('"evidenceofpresence":"bone"')) return true;
            if (dynProps.includes('"evidenceofpresence":"egg"')) return true;
            if (dynProps.includes('"vitality":"dead"')) return true;

            // 3. General Keyword Sweep (The "Safety Net")
            const bannedKeywords = [
                "track", "print", "footprint", "paw", "scat", "feces", "dropping", "poop", "dung", "spoor",
                "burrow", "nest", "den", "moult", "shed", "dead", "roadkill", "dor", "carcass", "remains", 
                "bone", "skull", "skeleton", "corpse", "killed", "died", "road kill", "found dead",
                "egg", "clutch"
            ];
            
            const textFields = [
                record.occurrenceRemarks, 
                record.fieldNotes, 
                record.media?.[0]?.description, 
                record.media?.[0]?.title, 
                record.occurrenceStatus
            ].filter(Boolean).join(" ").toLowerCase();

            const hasBannedWord = bannedKeywords.some(keyword => textFields.includes(keyword));
            
            // 4. Sampling Protocol Check
            const protocol = (record.samplingProtocol || "").toLowerCase();
            const isTraceProtocol = protocol.includes("track") || protocol.includes("sign") || protocol.includes("scat");

            return hasBannedWord || isTraceProtocol;
        };

        // --- COMPONENT: CountdownScreen ---
        const CountdownScreen = ({ onComplete }) => {
            const [count, setCount] = useState(3);
            const [emoji, setEmoji] = useState("ðŸ¦");
            const emojis = ["ðŸ¦", "ðŸ¯", "ðŸ»", "ðŸ¨", "ðŸ¼", "ðŸ¸", "ðŸ™", "ðŸ¦Š", "ðŸ¦“", "ðŸ¦„", "ðŸ¦…", "ðŸ", "ðŸ¦€", "ðŸ¦–"];

            useEffect(() => {
                if (count === 0) { onComplete(); return; }
                const timer = setTimeout(() => setCount(c => c - 1), 1000);
                return () => clearTimeout(timer);
            }, [count, onComplete]);

            useEffect(() => {
                const interval = setInterval(() => {
                    setEmoji(emojis[Math.floor(Math.random() * emojis.length)]);
                }, 150);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-emerald-900 text-white">
                <h2 className="text-3xl font-bold mb-8 animate-pulse text-emerald-200">ARE YOU READY?</h2>
                <div className="text-9xl mb-8 font-mono font-bold">{count > 0 ? count : "GO!"}</div>
                <div className="text-6xl swap-anim">{emoji}</div>
            </div>
            );
        };

        // --- HELPER: UNIQUE ANIMAL SELECTION ---
const getUniqueAnimal = (allAnimals) => {
    // 1. Get history from LocalStorage
    const historyJSON = localStorage.getItem('wildGuess_played');
    let played = historyJSON ? JSON.parse(historyJSON) : [];

    // 2. Filter out animals we've already seen
    const available = allAnimals.filter(a => !played.includes(a.name));

    // 3. If we've seen everything, clear history and restart
    if (available.length === 0) {
        played = [];
        localStorage.removeItem('wildGuess_played');
        return allAnimals[Math.floor(Math.random() * allAnimals.length)];
    }

    // 4. Pick a random animal from the remaining pool
    const selected = available[Math.floor(Math.random() * available.length)];

    // 5. Save this pick to history
    played.push(selected.name);
    localStorage.setItem('wildGuess_played', JSON.stringify(played));

    return selected;
};

        // --- MAIN COMPONENT ---
        const WildGuessGame = () => {
            const [view, setView] = useState('menu');
            const [animalData, setAnimalData] = useState(null);
            const [preloadedData, setPreloadedData] = useState(null);
            const [currentClueIndex, setCurrentClueIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(10);
            const [roundScore, setRoundScore] = useState(5);
            const [guessLocked, setGuessLocked] = useState(false);
            const [wrongGuesses, setWrongGuesses] = useState([]);
            const [gameResult, setGameResult] = useState(null);
            const [selectedGroup, setSelectedGroup] = useState(null); 
            const [showDebug, setShowDebug] = useState(false);
            const [gameId, setGameId] = useState(0);
            // --- NEW STATE FOR LOADING UI ---
            const [isLoading, setIsLoading] = useState(false);
            const [loadingProgress, setLoadingProgress] = useState(0);
            const [loadingMsgIndex, setLoadingMsgIndex] = useState(0);
            
            const LOADING_MESSAGES = [
                "Connecting to Satellite ðŸ›°ï¸",
                "Triangulating Signal ðŸ“¡", 
                "Tracking Wildlife ðŸ¾", 
                "Filtering Bad Data ðŸ§¹", 
                "Verifying Coordinates ðŸ“", 
                "Consulting Biologists ðŸ‘¨â€ðŸ”¬",
                "Loading Map Tiles ðŸ—ºï¸",
                "Enhancing Image ðŸ“¸"
            ];

            // --- MEMOIZED RANDOM STICKERS (Grid System) ---
            // Uses a "Jittered Grid" to prevent overlapping while keeping it organic.
            const menuStickers = useMemo(() => {
                const emojis = [
                    "ðŸ¦", "ðŸ¸", "ðŸ¦œ", "ðŸ¦‹", "ðŸ¦‡", "ðŸ¦’", "ðŸº", "ðŸž", "ðŸ¢", "ðŸ", 
                    "ðŸ˜", "ðŸ¦˜", "ðŸ™", "ðŸ»", "ðŸŠ", "ðŸ…", "ðŸ¦“", "ðŸ¦", "ðŸ¦©", "ðŸ¦‰", 
                    "ðŸ‹", "ðŸ", "ðŸ«", "ðŸ¦ˆ", "ðŸ¦", "ðŸŽ", "ðŸ€", "ðŸ–", "ðŸˆ", "ðŸ•"
                ];
                
                // Define a grid (e.g., 6 columns x 5 rows = 30 slots)
                const cols = 6;
                const rows = 5;
                const cellW = 100 / cols;
                const cellH = 100 / rows;

                return emojis.slice(0, cols * rows).map((emoji, i) => {
                    // Calculate Grid Position
                    const col = i % cols;
                    const row = Math.floor(i / cols);

                    // Add "Jitter" (Random offset within the cell)
                    // We allow movement up to 70% of the cell size so they don't touch edges
                    const jitterX = Math.random() * (cellW * 0.7);
                    const jitterY = Math.random() * (cellH * 0.7);

                    return {
                        id: i,
                        emoji,
                        // Base Grid Position + Jitter
                        left: (col * cellW) + jitterX,
                        top: (row * cellH) + jitterY,
                        
                        // Rotation: -30 to 30 degrees
                        rotation: Math.floor(Math.random() * 60) - 30,
                        
                        // Size: 3rem to 5rem
                        size: 3 + Math.random() * 2,
                        
                        // Opacity: MUCH LOWER now (0.1 to 0.2) to fade into background
                        opacity: 0.1 + Math.random() * 0.1 
                    };
                });
            }, []);

            useEffect(() => {
                let interval;
                if (isLoading) {
                    setLoadingProgress(0);
                    setLoadingMsgIndex(0);
                    interval = setInterval(() => {
                        setLoadingProgress(prev => Math.min(prev + 5, 95)); // Cap at 95% until done
                        setLoadingMsgIndex(prev => (prev + 1) % LOADING_MESSAGES.length);
                    }, 400); // Change text every 400ms
                }
                return () => clearInterval(interval);
            }, [isLoading]);
            
            // Track used animals to prevent repeats
            const [usedAnimals, setUsedAnimals] = useState(new Set());
            const timerRef = useRef(null);

            useEffect(() => {
                preloadNextGame();
            }, []);



            const preloadNextGame = async () => {
                try {
                    const data = await fetchValidAnimal();
                    setPreloadedData(data);
                } catch (e) {
                    console.warn("Background fetch failed", e);
                }
            };

            const startGame = async () => {
                setWrongGuesses([]);
                setCurrentClueIndex(0);
                setRoundScore(5);
                setGuessLocked(false);
                setGameResult(null);
                setSelectedGroup(null);
                setGameId(prev => prev + 1);
                
                // If we have data ready, go straight to countdown
                if (preloadedData) {
                    setAnimalData(preloadedData);
                    setPreloadedData(null); 
                    setView('countdown');
                } else {
                    // If no data, trigger the new button animation
                    setIsLoading(true); // <--- Starts the progress bar/text
                    try {
                        const data = await fetchValidAnimal();
                        setAnimalData(data);
                        setIsLoading(false); // <--- Stops animation
                        setView('countdown');
                    } catch (e) {
                        alert("Network error. Please try again.");
                        setIsLoading(false);
                    }
                }
            };

            const onCountdownComplete = () => {
                setView('game');
                startTimeForClue();
                preloadNextGame();
            };

            // --- FETCH DATA (With Dog Exclusion, Track Filter, & Cryptic Names) ---
            const fetchValidAnimal = async () => {
                // 1. Get History
                const historyJSON = localStorage.getItem('wildGuess_played');
                let played = historyJSON ? JSON.parse(historyJSON) : [];

                // 2. Filter available animals
                const available = ALL_ANIMALS_FLAT.filter(a => !played.includes(a.name));

                // 3. Reset if we've seen them all
                let target;
                if (available.length === 0) {
                    played = [];
                    localStorage.removeItem('wildGuess_played');
                    target = ALL_ANIMALS_FLAT[Math.floor(Math.random() * ALL_ANIMALS_FLAT.length)];
                } else {
                    target = available[Math.floor(Math.random() * available.length)];
                }

                // 4. Save to history
                if (!played.includes(target.name)) {
                     played.push(target.name);
                     localStorage.setItem('wildGuess_played', JSON.stringify(played));
                }

                // 5. Randomize Page
                const randomPage = Math.floor(Math.random() * 30) + 1; 

                console.log(`Hunting for: ${target.name} (${target.sciName}) on Page ${randomPage}`);

                try {
                    // API Call: Excludes Domestic Dogs (47144)
                    const response = await fetch(
                        `https://api.inaturalist.org/v1/observations?taxon_name=${target.sciName}&quality_grade=research&photos=true&per_page=1&page=${randomPage}&without_taxon_id=47144`
                    );
                    
                    const data = await response.json();

                    if (!data.results || data.results.length === 0) {
                        console.warn("No results on random page, retrying...");
                        return fetchValidAnimal(); 
                    }

                    const obs = data.results[0];
                    
                    // REJECT Low Quality Records
                    if (isLowQualityRecord(obs)) {
                        console.warn("Rejected Low Quality Record:", obs.id);
                        return fetchValidAnimal();
                    }

                    // Validate Coordinates & Photos
                    const lat = obs.geojson?.coordinates[1] || obs.location?.split(',')[0];
                    const lng = obs.geojson?.coordinates[0] || obs.location?.split(',')[1];

                    if (!lat || !lng || !obs.photos || obs.photos.length === 0) {
                        return fetchValidAnimal(); 
                    }

                    const dateObj = new Date(obs.observed_on || obs.created_at);
                    const dateStr = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                    return {
                        name: target.name,           
                        correctName: target.name, 
                        // MASKING LOGIC: Use 'displayLatin' if it exists, otherwise use real sciName
                        sciName: target.displayLatin || target.sciName,     
                        family: target.family || "Unknown Family", 
                        image: obs.photos[0].url.replace('square', 'original'),
                        lat: parseFloat(lat),
                        lng: parseFloat(lng),
                        location: obs.place_guess || "Unknown Wilderness",
                        recordedBy: obs.user?.login || obs.user?.name || "Unknown Observer",
                        link: obs.uri,
                        stats: {
                            trait: target.clue || target.hint || "No hint available.",
                            date: dateStr,
                            year: dateObj.getFullYear()
                        }
                    };

                } catch (error) {
                    console.error("Fetch failed:", error);
                    return fetchValidAnimal();
                }
            };

            const checkImageValidity = (url) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => reject(false);
                    setTimeout(() => reject(false), 3000); 
                    img.src = url;
                });
            };

            const processRecord = (record, targetAnimal, image) => {
                // Location Logic: Combine State + Country, filtering out empties
                const country = record.country || "";
                const state = record.stateProvince || "";
                const locationParts = [state, country].filter(part => part && part.trim() !== "");
                const locationStr = locationParts.length > 0 ? locationParts.join(", ") : "Unknown Location";
                
                const family = record.family || "Unknown Family";
                const year = record.year || new Date(record.eventDate).getFullYear();
                
                const dateObj = new Date(record.eventDate);
                const dateStr = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                // --- LOGIC: Use Custom Latin if defined (to hide obvious names like Gorilla) ---
                const displaySciName = targetAnimal.customLatin || record.scientificName;

                return {
                    correctGroupEmoji: targetAnimal.groupEmoji,
                    correctName: targetAnimal.name, 
                    sciName: displaySciName, // <--- Using the safe name here
                    family: family,
                    location: locationStr, 
                    lat: record.decimalLatitude,
                    lng: record.decimalLongitude,
                    image: image,
                    recordedBy: record.recordedBy || "Unknown Observer",
                    link: record.occurrenceID,
                    gbifID: record.gbifID,
                    stats: {
                        date: dateStr,
                        year: year,
                        trait: targetAnimal.clue 
                    },
                    raw: record
                };
            };

            const startTimeForClue = () => {
                setTimeLeft(10);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            advanceClue();
                            return 10;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            const advanceClue = () => {
                setCurrentClueIndex(prev => {
                    if (prev >= 4) { endGame('loss'); return 4; }
                    setGuessLocked(false);
                    setRoundScore(score => Math.max(1, score - 1));
                    return prev + 1;
                });
            };

            const skipClue = () => {
                if (currentClueIndex < 4) {
                    setTimeLeft(10); 
                    advanceClue();
                }
            };

            const handleFinalGuess = (animalName) => {
                if (guessLocked || view !== 'game') return;
                if (animalName === animalData.correctName) {
                    endGame('win');
                } else {
                    setWrongGuesses(prev => [...prev, animalName]);
                    if (currentClueIndex === 4) { endGame('loss'); } 
                    else { setTimeLeft(10); advanceClue(); }
                }
            };

            const endGame = (result) => {
                clearInterval(timerRef.current);
                setGameResult(result);
                setView('summary');
            };

            // --- VIEW: MAIN MENU (Randomized) ---
            if (view === 'menu') {
                return (
                    // Dark Forest Gradient Background
                    <div className="h-screen w-full bg-gradient-to-b from-green-900 to-green-700 overflow-hidden relative flex flex-col items-center justify-center p-4">
                        
                        {/* BACKGROUND STICKERS (Generated Randomly) */}
                        <div className="absolute inset-0 overflow-hidden pointer-events-none">
                            {menuStickers.map((sticker) => (
                                <div 
                                    key={sticker.id}
                                    className="absolute emoji-sticker transition-transform duration-1000 ease-in-out hover:scale-110"
                                    style={{
                                        top: `${sticker.top}%`,
                                        left: `${sticker.left}%`,
                                        fontSize: `${sticker.size}rem`,
                                        transform: `rotate(${sticker.rotation}deg)`,
                                        opacity: sticker.opacity
                                    }}
                                >
                                    {sticker.emoji}
                                </div>
                            ))}
                        </div>

                        {/* MENU CONTENT CARD */}
                        <div className="relative z-10 flex flex-col items-center w-full max-w-md">
                            
                            {/* TITLE: One Line, Thick Border */}
                            {/* Use 'text-green-500' below to change the fill color */}
                            <h1 className="font-freckle text-6xl md:text-8xl text-green-950 sticker-text drop-shadow-2xl mb-4 tracking-wider leading-none whitespace-nowrap">
                                WILD GUESS
                            </h1>

                            {/* INSTRUCTIONS CARD */}
                            <div className="bg-white/95 backdrop-blur-sm p-5 md:p-6 rounded-3xl shadow-2xl w-full text-center border-4 border-white transform -rotate-1 mb-6">
                                <p className="text-slate-400 font-bold uppercase tracking-widest text-[10px] mb-3">Mission Brief</p>
                                
                                <div className="flex justify-between items-center px-2 mb-4">
                                    <div className="flex flex-col items-center">
                                        <span className="text-4xl mb-1 filter drop-shadow-sm">ðŸ“</span>
                                        <span className="text-xs font-black text-slate-700 uppercase">Map</span>
                                    </div>
                                    <div className="text-slate-300 text-xl">âžœ</div>
                                    <div className="flex flex-col items-center">
                                        <span className="text-4xl mb-1 filter drop-shadow-sm">ðŸ§¬</span>
                                        <span className="text-xs font-black text-slate-700 uppercase">Data</span>
                                    </div>
                                    <div className="text-slate-300 text-xl">âžœ</div>
                                    <div className="flex flex-col items-center">
                                        <span className="text-4xl mb-1 filter drop-shadow-sm">ðŸ¦</span>
                                        <span className="text-xs font-black text-slate-700 uppercase">Guess</span>
                                    </div>
                                </div>

                                <div className="pt-3 border-t border-slate-100">
                                    <p className="text-sm text-slate-600 font-bold">
                                        Identify the animal from 5 clues.
                                    </p>
                                </div>
                            </div>

                            {/* LOADING BUTTON */}
                            <button 
                                onClick={startGame}
                                disabled={isLoading} 
                                className={`
                                    relative overflow-hidden text-white font-bold py-4 rounded-full shadow-[0_6px_0_#14532d] active:shadow-none active:translate-y-1 transform transition-all border-4 border-white
                                    ${isLoading ? 'w-full bg-green-900 cursor-not-allowed' : 'w-full hover:scale-105 bg-green-600 hover:bg-green-500'}
                                `}
                            >
                                {isLoading ? (
                                    <>
                                        <div 
                                            className="absolute inset-0 bg-green-500 transition-all duration-300 ease-out opacity-100" 
                                            style={{ width: `${loadingProgress}%` }}
                                        ></div>
                                        <span className="relative z-10 font-mono text-sm uppercase tracking-wider flex items-center justify-center gap-2 text-shadow-sm">
                                            {LOADING_MESSAGES[loadingMsgIndex]}
                                        </span>
                                    </>
                                ) : (
                                    <span className="text-2xl font-black tracking-widest uppercase drop-shadow-md">
                                        START HUNT
                                    </span>
                                )}
                            </button>

                        </div>
                    </div>
                );
            }

            if (view === 'loading') return <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-100"><div className="animate-spin text-4xl mb-4">ðŸŒ</div><h2 className="text-xl font-bold text-slate-700">Connecting to GBIF...</h2></div>;
            
            if (view === 'countdown') return <CountdownScreen onComplete={onCountdownComplete} />;

            return (
                <div className="h-screen w-full flex flex-col md:flex-row bg-slate-100 overflow-hidden relative">

                    {/* --- NEW: LANDSCAPE WARNING OVERLAY --- */}
                <div id="landscape-warning" className="fixed inset-0 z-[100] bg-slate-900 text-white flex-col items-center justify-center p-6 text-center">
                <div className="text-6xl mb-6">ðŸ”„</div>
                <h2 className="text-2xl font-bold mb-2">Please Rotate Device</h2>
                <p className="text-slate-300">This game is designed for portrait mode.</p>
            </div>

            <div className="flex-1 flex flex-col bg-white m-2 rounded-xl shadow-sm overflow-hidden relative order-1">
            <div className="h-2 bg-slate-200 w-full flex-shrink-0"><div className="h-full bg-emerald-500 transition-all duration-1000 linear" style={{ width: `${(timeLeft / 10) * 100}%` }}></div></div>
            <div className="flex-1 relative">

            {/* --- GLOBAL EXIT BUTTON (Small) --- */}
                    <button
                        onClick={() => setView('menu')}
                        className="absolute top-2 left-2 z-[60]
                        bg-gradient-to-b from-blue-400 to-blue-600 border-2 border-slate-300 rounded shadow-md
                        text-white font-bold uppercase tracking-widest text-[10px] px-2 py-1 flex items-center gap-1
                        hover:from-blue-500 hover:to-blue-700 active:scale-95 transition-all"
                        title="Exit to Main Menu"
                    >
                        <span className="text-xs filter drop-shadow-sm">ðŸ”™</span>
                        <span className="drop-shadow-sm">EXIT</span>
                    </button>

                            {/* --- MAP LAYER --- */}
            <div className="absolute inset-0" key={gameId}>
            <div className={`absolute inset-0 transition-opacity duration-500 ${currentClueIndex >= 0 ? 'opacity-100' : 'opacity-0'}`}>
                                    {/* CLUE 1 & 2: Dynamic Zoom */}
            {animalData && <MapClue lat={animalData.lat} lng={animalData.lng} zoom={currentClueIndex === 0 ? 2 : 5} />}

                                    {/* GRADIENT REMOVED HERE */}

            </div>



        {/* DESKTOP ONLY: Full Screen Photo Overlay (Hidden on Mobile) */}
        <div className={`hidden md:block absolute inset-0 z-10 transition-opacity duration-1000 bg-slate-200 ${currentClueIndex >= 4 ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
        {animalData?.image && (<div className="w-full h-full relative"><img src={animalData.image} className="w-full h-full object-cover" alt="Revealed Animal" /><div className="absolute inset-0 bg-black/10"></div></div>)}
    </div>
    </div>

{/* --- HEADER SECTION --- */}
{/* Added 'hidden md:block' to remove title on mobile to save space */}
<div className="hidden md:block absolute top-0 left-0 right-0 z-30 pt-6 text-center pointer-events-none">
{/* Increased drop-shadow heavily so text is readable without gradient */}
<h2 className="text-3xl md:text-4xl font-black text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] tracking-tight uppercase leading-none">
Take a <span className="text-emerald-400">Wild Guess</span>
</h2>
<p className="text-white text-sm font-bold mt-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.9)] uppercase tracking-widest">Can you identify this animal?</p>
</div>

{/* --- CLUES SECTION --- */}
<div className="absolute inset-0 top-2 md:top-24 p-4 pb-24 flex flex-col items-center justify-start pointer-events-none overflow-y-auto clue-scroll z-20 space-y-2">

{/* MOBILE ONLY (Index 4): Photo Box replaces text clues */}
{currentClueIndex === 4 && animalData?.image && (
    // Changed dimensions from fixed square (w-64 h-64) to wide rectangle (w-full max-w-sm h-48)
    <div className="md:hidden bg-slate-200 rounded-2xl shadow-2xl overflow-hidden border-4 border-white w-full max-w-sm h-48 flex-shrink-0 animate-pop mb-2">
    <img src={animalData.image} className="w-full h-full object-cover" alt="Clue" />
    </div>
    )}

{/* CLUE 2: Location Text */}
{/* Logic: Show if index >= 1. IF index is 4, HIDE on mobile, SHOW on desktop. */}
<div className={`transition-all duration-500 transform ${currentClueIndex >= 1 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'} ${currentClueIndex === 4 ? 'hidden md:block' : ''}`}>
<div className="bg-white/90 backdrop-blur-md px-4 py-2 rounded-lg shadow-xl border border-white/50">
<span className="text-[10px] font-bold text-slate-400 uppercase block text-center tracking-wider">Location</span>
<span className="text-slate-800 font-bold text-lg leading-tight block">{animalData?.location}</span>
</div>
</div>

                                {/* CLUE 3: Family & Scientific Name */}
                                {/* Logic: Show if index >= 2. IF index is 4, HIDE on mobile, SHOW on desktop. */}
<div className={`transition-all duration-500 transform ${currentClueIndex >= 2 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'} ${currentClueIndex === 4 ? 'hidden md:block' : ''}`}>
<div className="bg-white/90 backdrop-blur-md px-6 py-3 rounded-lg shadow-xl border border-white/50 text-center min-w-[220px]">
<div className="mb-2">
<span className="text-[10px] font-bold text-slate-400 uppercase block tracking-wider">Family</span>
<span className="text-indigo-600 font-mono font-bold text-lg leading-none">{animalData?.family}</span>
</div>
<div className="border-t border-slate-200/50 pt-2">
<span className="text-[10px] font-bold text-slate-400 uppercase block tracking-wider">Scientific Name</span>
<span className="text-emerald-800 italic font-serif text-xl leading-none">{animalData?.sciName}</span>
</div>
</div>
</div>

{/* CLUE 4: Vague Description (Visible on both) */}
<div className={`transition-all duration-500 transform ${currentClueIndex >= 3 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'}`}>
<div className="bg-emerald-50/95 backdrop-blur-md px-5 py-3 rounded-lg shadow-xl border border-emerald-100 max-w-sm text-center">
<span className="text-[10px] font-bold text-emerald-600 uppercase block mb-1 tracking-wider">Hint</span>
<div className="text-emerald-900 font-medium italic text-lg leading-snug">"{animalData?.stats?.trait}"</div>
</div>
</div>
</div>
</div>
<div className="h-14 bg-white border-t border-slate-100 flex items-center justify-between px-4 z-10 flex-shrink-0">
<div className="text-slate-500 font-mono text-sm">PTS: <span className="text-emerald-600 font-bold">{roundScore}</span></div>
<div className="flex gap-2">
<button onClick={() => endGame('surrender')} className="px-3 py-1 text-xs text-slate-400 hover:text-red-500 font-medium">GIVE UP</button>
<button onClick={skipClue} className="bg-blue-50 text-blue-600 px-4 py-1 rounded-full text-xs font-bold hover:bg-blue-100 transition">NEXT CLUE</button>
</div>
</div>
</div>

{/* --- SIDEBAR / ANSWER SECTION --- */}
{/* Changed h-1/2 to h-[35%] to give more room to clues on mobile */}
<div className="h-[35%] md:h-full md:w-96 bg-slate-50 p-2 overflow-hidden border-t md:border-t-0 md:border-l border-slate-200 order-2 flex flex-col shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] z-40 relative">

{/* CATEGORY SELECTION VIEW */}
{!selectedGroup && (
    <div className="grid grid-cols-2 md:grid-cols-4 gap-2 overflow-y-auto custom-scroll p-1 h-full content-start">
{/* 1. The "All Animals" Button */}
                                <button
                                    onClick={() => setSelectedGroup("ALL")}
                                    disabled={guessLocked}
                                    className={`
                                        rounded-xl flex items-center shadow-sm transition-all duration-200
                                        /* CHANGED: Light Grey Style */
                                        bg-slate-200 text-slate-700 hover:bg-slate-300 hover:shadow-md cursor-pointer border border-slate-300
                                        /* Mobile: Horizontal Rectangle */
                                        flex-row justify-start px-3 py-2 h-14
                                        /* Desktop: Vertical Square */
                                        md:flex-col md:justify-center md:aspect-square md:h-auto md:px-0
                                        ${guessLocked ? 'opacity-50' : ''}
                                    `}
                                >
                                    <span className="text-2xl mr-3 md:mr-0 md:mb-1">ðŸŒŽ</span>
                                    <span className="text-[10px] md:text-[10px] font-bold uppercase tracking-tight text-left md:text-center leading-tight">All Animals</span>
                                </button>

{/* 2. The Standard Categories */}
{ANIMAL_GROUPS.map((group, idx) => (
    <button
    key={idx}
    disabled={guessLocked}
    onClick={() => setSelectedGroup(group)}
    className={`
        rounded-xl flex items-center shadow-sm transition-all duration-200
        bg-white hover:bg-emerald-50 hover:shadow-md cursor-pointer border border-slate-100
        /* Mobile: Horizontal Rectangle */
        flex-row justify-start px-3 py-2 h-14
        /* Desktop: Vertical Square */
        md:flex-col md:justify-center md:aspect-square md:h-auto md:px-0
        ${guessLocked ? 'opacity-50' : ''}
        `}
        >
        <span className="text-2xl mr-3 md:mr-0 md:mb-1">{group.emoji}</span>
        <span className="text-[10px] text-slate-500 font-bold uppercase tracking-tight text-left md:text-center leading-tight">{group.name}</span>
        </button>
        ))}
        </div>
        )}

    {/* ANIMAL LIST VIEW */}
    {selectedGroup && (
        <div className="flex flex-col h-full">
        <button 
        onClick={() => setSelectedGroup(null)}
        className="mb-2 flex items-center text-slate-500 hover:text-emerald-600 text-sm font-bold px-2 py-1 flex-shrink-0"
        >
        â† Back to Categories
        </button>

        <div className="text-center mb-2 flex-shrink-0">
        <span className="text-3xl inline-block mr-2">{selectedGroup === "ALL" ? "ðŸŒŽ" : selectedGroup.emoji}</span>
        <span className="text-lg font-bold text-slate-700">{selectedGroup === "ALL" ? "All Animals" : selectedGroup.name}</span>
        </div>

        <div className={`grid gap-2 overflow-y-auto custom-scroll p-1 flex-1 content-start ${selectedGroup === "ALL" ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                    {(selectedGroup === "ALL" ? ALL_ANIMALS_FLAT : selectedGroup.animals).map((animal, idx) => {
                                        const isWrong = wrongGuesses.includes(animal.name);
                                        return (
                                            <button
                                                key={idx}
                                                disabled={guessLocked || isWrong}
                                                onClick={() => handleFinalGuess(animal.name)}
                                                className={`
                                                    rounded-lg font-bold shadow-sm border border-slate-100 transition-all leading-tight
                                                    ${selectedGroup === "ALL" ? 'py-2 px-1 text-[10px] h-12' : 'py-3 px-2 text-sm'}
                                                    ${isWrong 
                                                        ? 'bg-red-50 text-red-300 border-red-100 cursor-not-allowed' 
                                                        : 'bg-white text-slate-700 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200'}
                                                    ${guessLocked ? 'opacity-50' : ''}
                                                `}
                                            >
                                                {/* SHOW NAME + EMOJI (Only in All Animals view) */}
                                                {animal.name} {selectedGroup === "ALL" && <span className="opacity-60 ml-0.5">{animal.groupEmoji}</span>}
                                            </button>
                                        )
                                    })}
                                </div>
                    </div>
                    )}
                </div>

                {view === 'summary' && (
                    <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                    <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-pop flex flex-col max-h-[90vh]">
                    <div className="h-64 bg-slate-200 relative flex-shrink-0">
                    {animalData?.image ? (<img src={animalData.image} className="w-full h-full object-cover" alt="Animal" />) : (<div className="w-full h-full flex items-center justify-center text-slate-400">No Image</div>)}
                        <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 pt-12">
                        <h2 className="text-white text-3xl font-bold leading-none">{animalData?.correctName}</h2>
                        <p className="text-white/80 text-sm italic font-serif mt-1">{animalData?.sciName}</p>
                        </div>
                        </div>
                        <div className="p-6 text-center flex-1 overflow-y-auto custom-scroll">
                        {gameResult === 'win' ? (
                            <div className="mb-6"><div className="text-5xl mb-2 animate-bounce">ðŸŽ‰</div><h3 className="text-2xl font-bold text-emerald-600 mb-1">Correct!</h3><p className="text-slate-600 font-medium">You earned <span className="text-emerald-600 font-bold">{roundScore} points</span>.</p></div>
                            ) : (
                            <div className="mb-6"><div className="text-5xl mb-2">â˜ ï¸</div><h3 className="text-2xl font-bold text-red-600 mb-1">Missed it!</h3><p className="text-slate-600">Better luck next time.</p></div>
                        )}
                        <div className="bg-slate-50 rounded-xl p-4 text-left space-y-3 text-sm border border-slate-100 shadow-inner">
                        <div className="flex justify-between border-b border-slate-200 pb-2">
                        <span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Observed By</span>
                                            {/* Hyperlink Logic */}
                        {animalData?.link ? (
                            <a 
                            href={animalData.link} 
                            target="_blank" 
                            rel="noopener noreferrer"
                            className="text-emerald-600 font-medium hover:underline truncate max-w-[150px]"
                            >
                            {animalData.recordedBy} â†—
                            </a>
                            ) : (
                            <span className="text-slate-700 font-medium">{animalData?.recordedBy}</span>
                        )}
                        </div>
                        <div className="flex justify-between border-b border-slate-200 pb-2"><span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Date</span><span className="text-slate-700 font-medium">{animalData?.stats?.date}</span></div>
                        <div className="flex justify-between border-b border-slate-200 pb-2"><span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Location</span><span className="text-slate-700 text-right max-w-[60%] font-medium">{animalData?.location}</span></div>

                                        {/* --- UPDATED CITATION FOOTER --- */}
                        <div className="pt-2 text-center border-t border-slate-200 mt-2">
                        <p className="text-[10px] text-slate-400 leading-tight">
                        Data source: <a href="https://doi.org/10.15468/ab3s5x" target="_blank" className="underline hover:text-emerald-500">iNaturalist Research-grade Observations</a>
                        <br/>
                        accessed via GBIF.org
                        </p>
                        </div>
                        </div>
                        </div>
                        <div className="p-4 bg-white border-t border-slate-100 flex-shrink-0">
                        <button onClick={startGame} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-emerald-200 transform hover:scale-[1.02]">PLAY AGAIN</button>
                        </div>
                        </div>
                        </div>
                    )}
                        </div>
                        );
                    };

                    const root = ReactDOM.createRoot(document.getElementById('root'));
                    root.render(<WildGuessGame />);
                </script>
            </body>
            </html>