<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Wild Guess - Live Research Grade</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Rubik:wght@400;600;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Rubik', sans-serif; background-color: #f0fdf4; overscroll-behavior: none; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        
        @keyframes pop {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
        .pop { animation: pop 0.3s ease-out; }

        @keyframes swap {
            0% { transform: scale(0.8); opacity: 0.5; }
            50% { transform: scale(1.1); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .swap-anim { animation: swap 0.15s ease-in-out; }

        .leaflet-container { height: 100%; width: 100%; border-radius: 0.5rem; z-index: 0; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: transparent; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }


        .custom-pin {
            background-color: #ef4444;
            width: 16px; 
            height: 16px; 
            border-radius: 50%; 
            border: 3px solid white; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        const ANIMAL_GROUPS = [
            {
                emoji: "üê∫", name: "Canines",
                animals: [
                    { name: "Wolf", sciName: "Canis lupus", clue: "Pack hunter whose howl defines the wilderness; ancestor of the domestic dog." },
                    { name: "Coyote", sciName: "Canis latrans", clue: "Adaptable trickster of folklore; known for yipping at the moon." },
                    { name: "Fox", sciName: "Vulpes vulpes", clue: "Cunning, bushy-tailed omnivore that hunts with a characteristic pounce." },
                    { name: "Dingo", sciName: "Canis lupus dingo", clue: "Apex predator of the Australian outback; rarely barks." },
                    { name: "Wild Dog", sciName: "Lycaon pictus", clue: "Mottled African hunter with rounded ears; lives in close-knit packs." },
                    { name: "Jackal", sciName: "Canis aureus", clue: "Scavenger of the savanna; often associated with Anubis in myth." }
                ]
            },
            {
                emoji: "ü¶Å", name: "Felines",
                animals: [
                    { name: "Lion", sciName: "Panthera leo", clue: "Only social cat; males sport a regal ruff of hair." },
                    { name: "Tiger", sciName: "Panthera tigris", clue: "Striped ambush predator; swims well and rules the Asian jungles." },
                    { name: "Cheetah", sciName: "Acinonyx jubatus", clue: "Sprint specialist with non-retractable claws; hunts by day." },
                    { name: "Jaguar", sciName: "Panthera onca", clue: "New World cat with a bite strong enough to crack turtle shells." },
                    { name: "Snow Leopard", sciName: "Panthera uncia", clue: "Ghost of the mountains; uses a massive tail for balance on cliffs." },
                    { name: "Cougar", sciName: "Puma concolor", clue: "Mountain dweller with the most names of any animal; screams like a human." }
                ]
            },
            {
                emoji: "üêª", name: "Bears",
                animals: [
                    { name: "Bear (Brown)", sciName: "Ursus arctos", clue: "Massive omnivore with a shoulder hump; fishes during salmon runs." },
                    { name: "Bear (Polar)", sciName: "Ursus maritimus", clue: "Marine predator of the ice; skin is black, but fur appears white." },
                    { name: "Panda", sciName: "Ailuropoda melanoleuca", clue: "Bamboo specialist with a modified wrist bone acting as a thumb." },
                    { name: "Bear (Black)", sciName: "Ursus americanus", clue: "Forest climber of North America; despite the name, can be cinnamon colored." },
                    { name: "Bear (Sun)", sciName: "Helarctos malayanus", clue: "Smallest of its kind; arboreal with a golden chest crescent." }
                ]
            },
            {
                emoji: "üêí", name: "Primates",
                animals: [
                    { name: "Gorilla", sciName: "Gorilla", customLatin: "Family: Hominidae", clue: "Gentle giant of the jungle; silverbacks lead the troop." },
                    { name: "Chimpanzee", sciName: "Pan troglodytes", clue: "Tool-using ape; shares nearly 99% of DNA with humans." },
                    { name: "Orangutan", sciName: "Pongo", clue: "Solitary 'Person of the Forest'; rare red ape of Sumatra/Borneo." },
                    { name: "Lemur", sciName: "Lemur catta", clue: "Prosimian endemic to one island; famous for its ghostly stare and striped tail." },
                    { name: "Baboon", sciName: "Papio anubis", clue: "Ground-dweller with a dog-like muzzle and formidable canines." },
                    { name: "Mandrill", sciName: "Mandrillus sphinx", clue: "World's largest monkey; features a vibrant red and blue face." }
                ]
            },
            {
                emoji: "üê≠", name: "Small Mammals", 
                animals: [
                    { name: "Mouse", sciName: "Mus musculus", clue: "Tiny commensal squeaker; likely the most numerous mammal in human homes." },
                    { name: "Rat", sciName: "Rattus norvegicus", customLatin: "Family: Muridae", clue: "Highly intelligent scavenger; thrived by hitching rides on ancient ships." },
                    { name: "Squirrel", sciName: "Sciurus vulgaris", clue: "Bushy-tailed hoarder; plays a key role in planting forests by forgetting nuts." },
                    { name: "Rabbit", sciName: "Oryctolagus cuniculus", clue: "Long-eared hopper; lives in warrens and breeds proverbially fast." },
                    { name: "Hedgehog", sciName: "Erinaceus europaeus", clue: "Nocturnal insectivore; rolls into a prickly ball when threatened." },
                    { name: "Raccoon", sciName: "Procyon lotor", clue: "Masked bandit of the trash can; washes food with dexterous paws." },      
                    { name: "Skunk", sciName: "Mephitis mephitis", clue: "Boldly striped and slow-moving; armed with a chemical weapon." }, 
                    { name: "Meerkat", sciName: "Suricata suricatta", clue: "Social desert dweller; stands upright on sentry duty." }  
                ]
            },
            {
                emoji: "üîÆ", name: "Unique Mammals", 
                animals: [
                    { name: "Platypus", sciName: "Ornithorhynchus anatinus", clue: "Bio-fluorescent monotreme; looks like a beaver built by a duck." },
                    { name: "Sloth", sciName: "Bradypus variegatus", clue: "Host to algae in its fur; so slow it descends only once a week." },
                    { name: "Armadillo", sciName: "Dasypus novemcinctus", clue: "Leathery tank of the Americas; the only mammal with a shell." },
                    { name: "Bat", sciName: "Tadarida brasiliensis", clue: "Only mammal capable of true flight; navigates via echolocation." },
                    { name: "Beaver", sciName: "Castor fiber", clue: "Nature's engineer; fells trees to create its own aquatic habitat." }, 
                    { name: "Capybara", sciName: "Hydrochoerus hydrochaeris", clue: "Giant riparian grazer; the world's largest living rodent." } 
                ]
            },
            {
                emoji: "üêÆ", name: "Farm",
                animals: [
                    { name: "Cow", sciName: "Bos taurus", clue: "Ruminant grazer; historically sacred in some cultures, burgers in others." },
                    { name: "Pig", sciName: "Sus scrofa", clue: "High IQ omnivore; descends from wild boars and loves mud." },
                    { name: "Sheep", sciName: "Ovis aries", clue: "Flocking herbivore; domesticated for its continuously growing fleece." },
                    { name: "Goat", sciName: "Capra hircus", clue: "Sure-footed climber with rectangular pupils; will eat almost anything." },
                    { name: "Chicken", sciName: "Gallus gallus", clue: "Descendant of the Red Junglefowl; wakes the farm at dawn." },
                    { name: "Horse", sciName: "Equus caballus", clue: "Single-toed galloper; revolutionized human transport and warfare." },
                    { name: "Donkey", sciName: "Equus asinus", clue: "Sturdy beast of burden; loud brayer with long ears." },
                    { name: "Llama", sciName: "Lama glama", clue: "Andean pack animal; spits when annoyed and provides warm wool." }
                ]
            },
            {
                emoji: "üêò", name: "Herbivores",
                animals: [
                    { name: "Giraffe", sciName: "Giraffa", clue: "Browser of treetops; born with horns and a purple tongue." },
                    { name: "Zebra", sciName: "Equus quagga", clue: "Savanna grazer; no two individuals share the same stripe pattern." },
                    { name: "Elephant", sciName: "Loxodonta africana", clue: "Intelligent matriarchal giant; communicates via subsonic rumbles." },
                    { name: "Hippo", sciName: "Hippopotamus amphibius", clue: "River titan that secretes 'blood sweat'; territorial and dangerous." },
                    { name: "Moose", sciName: "Alces alces", clue: "Solitary northern giant; dives underwater to eat aquatic plants." },
                    { name: "Deer", sciName: "Cervus elaphus", clue: "Antlered forest dweller; males rut in autumn to secure mates." },
                    { name: "Rhino", sciName: "Ceratotherium simum", clue: "Armored tank of the bush; hunted for its keratin horn." }
                ]
            },
            {
                emoji: "ü¶å", name: "Antelopes",
                animals: [
                    { name: "Wildebeest", sciName: "Connochaetes taurinus", clue: "The 'Gnu'; crosses rivers in massive herds during the Great Migration." },
                    { name: "Impala", sciName: "Aepyceros melampus", clue: "McDonald's of the Bush; known for distinct black heel markings." },
                    { name: "Gazelle", sciName: "Eudorcas thomsonii", clue: "Delicate sprinter; performs 'stotting' jumps to signal fitness." },
                    { name: "Oryx", sciName: "Oryx gazella", clue: "Desert survivor; wields straight, rapier-like horns." },
                    { name: "Kudu", sciName: "Tragelaphus strepsiceros", clue: "Grey ghost of the bush; males bear magnificent corkscrew horns." },
                    { name: "Springbok", sciName: "Antidorcas marsupialis", clue: "National symbol of South Africa; famous for its pronking displays." }
                ]
            },
            {
                emoji: "ü¶ò", name: "Marsupials",
                animals: [
                    { name: "Kangaroo", sciName: "Macropus rufus", clue: "The 'Big Red'; boxes rivals and carries young in a pouch." },
                    { name: "Koala", sciName: "Phascolarctos cinereus", clue: "Sleepy eucalyptus specialist; possess fingerprints like humans." },
                    { name: "Wombat", sciName: "Vombatus ursinus", clue: "Cube-pooping burrower; uses a reinforced rump for defense." },
                    { name: "Sugar Glider", sciName: "Petaurus breviceps", clue: "Small nocturnal arboreal; uses a membrane to soar between trees." }, // <--- REPLACED TASMANIAN DEVIL
                    { name: "Opossum", sciName: "Didelphis virginiana", clue: "New World marsupial; famous for feigning death." }
                ]
            },
            {
                emoji: "ü¶Ö", name: "Raptors",
                animals: [
                    { name: "Eagle", sciName: "Haliaeetus leucocephalus", clue: "Apex predator of the sky; symbol of freedom in the west." },
                    { name: "Owl", sciName: "Tyto alba", clue: "Silent night flyer; can rotate its head 270 degrees." },
                    { name: "Hawk", sciName: "Buteo jamaicensis", clue: "Broad-winged soarer; its scream is often dubbed over eagle footage." },
                    { name: "Falcon", sciName: "Falco peregrinus", clue: "Aerodynamic diver; the fastest member of the animal kingdom." },
                    { name: "Vulture", sciName: "Cathartes aura", clue: "Bald-headed recycler; cleans the environment by eating the dead." },
                    { name: "Osprey", sciName: "Pandion haliaetus", clue: "Specialized angler; carries fish aerodynamically with reversible toes." }
                ]
            },
            {
                emoji: "ü¶Ü", name: "Water Birds",
                animals: [
                    { name: "Penguin", sciName: "Aptenodytes forsteri", clue: "Flightless tuxedo wearer; endures the harshest winter on Earth." },
                    { name: "Pelican", sciName: "Pelecanus occidentalis", clue: "Coastal fisher; its beak holds more than its belly." },
                    { name: "Swan", sciName: "Cygnus olor", clue: "Symbol of grace; monogamous waterfowl with a powerful wing strike." },
                    { name: "Flamingo", sciName: "Phoenicopterus roseus", clue: "Filter feeder; turns pink from the carotenoids in its diet." },
                    { name: "Stork", sciName: "Ciconia ciconia", clue: "Leggy wader; mythologically associated with delivering babies." },
                    { name: "Duck", sciName: "Anas platyrhynchos", clue: "Dabbling swimmer; males often sport an iridescent green head." }
                ]
            },
            {
                emoji: "ü¶ú", name: "Exotic Birds",
                animals: [
                    { name: "Macaw", sciName: "Ara macao", clue: "Vibrant rainforest loudmouth; cracks nuts with a powerful beak." },
                    { name: "Toucan", sciName: "Ramphastos toco", clue: "Frugivore with a bill that looks too large for its body." },
                    { name: "Peacock", sciName: "Pavo cristatus", clue: "Ground bird; male performs a dazzling 'eyed' fan dance." },
                    { name: "Hummingbird", sciName: "Archilochus colubris", clue: "Nectar sipper; the only bird capable of flying backwards." },
                    { name: "Parrot", sciName: "Psittacus erithacus", clue: "Grey intellectual; capable of mimicking human speech with context." },
                    { name: "Ibis", sciName: "Eudocimus ruber", clue: "Brilliant red wading bird found in wetlands." }
                ]
            },
            {
                emoji: "üê¶", name: "Birds",
                animals: [
                    { name: "Robin", sciName: "Erithacus rubecula", clue: "Herald of spring; aggressive defender of its garden territory." },
                    { name: "Blue Jay", sciName: "Cyanocitta cristata", clue: "Crested corvid; noisy mimic known for mobbing hawks." },
                    { name: "Sparrow", sciName: "Passer domesticus", clue: "Urban survivor; ubiquitous brown bird that chirps in hedges." },
                    { name: "Crow", sciName: "Corvus corone", clue: "All-black problem solver; recognizes individual human faces." },
                    { name: "Pigeon", sciName: "Columba livia", clue: "Cliff-dwelling dove adapted to city skyscrapers; creates 'milk' for young." },
                    { name: "Ostrich", sciName: "Struthio camelus", clue: "Flightless titan; lays the largest egg of any living animal." }
                ]
            },
            {
                emoji: "üêä", name: "Reptiles",
                animals: [
                    { name: "Crocodile", sciName: "Crocodylus niloticus", clue: "Prehistoric ambush predator; has a V-shaped snout and toothy grin." },
                    { name: "Cobra", sciName: "Ophiophagus hannah", clue: "Hooded serpent; rises up to display a spectacle pattern." },
                    { name: "Tortoise", sciName: "Chelonoidis", clue: "Armored grazer; can live well over 100 years." },
                    { name: "Iguana", sciName: "Iguana iguana", customLatin: "Class: Reptilia", clue: "Spiny arboreal lizard; sneezes salt and drops from trees when cold." },
                    { name: "Komodo Dragon", sciName: "Varanus komodoensis", clue: "Island giant; hunts with bacteria-laden saliva and venom." },
                    { name: "Boa", sciName: "Boa constrictor", customLatin: "Suborder: Serpentes", clue: "New World constrictor; gives birth to live young." },
                    { name: "Chameleon", sciName: "Furcifer pardalis", clue: "Zygodactyl climber; changes color for mood, not just camouflage." }
                ]
            },
            {
                emoji: "üê∏", name: "Amphibians",
                animals: [
                    { name: "Bullfrog", sciName: "Lithobates catesbeianus", clue: "Voracious eater; anything that fits in its mouth is food." },
                    { name: "Toad", sciName: "Bufo bufo", clue: "Warty walker; produces bufotoxin to deter predators." },
                    { name: "Salamandra", sciName: "Salamandra salamandra", clue: "Fire lizard of legend; warns predators with yellow spots." },
                    { name: "Axolotl", sciName: "Ambystoma mexicanum", clue: "The 'Walking Fish'; stays in its larval form forever." },
                    { name: "Tree Frog", sciName: "Agalychnis callidryas", clue: "Sticky-toed climber; famous for bright green skin and red eyes." }
                ]
            },
            {
                emoji: "üê¨", name: "Marine",
                animals: [
                    { name: "Whale", sciName: "Balaenoptera musculus", clue: "Gentle giant; heart is the size of a small car." },
                    { name: "Dolphin", sciName: "Tursiops", clue: "Playful cetacean; uses distinct whistles to identify friends." },
                    { name: "Shark", sciName: "Carcharodon carcharias", clue: "Cartilaginous predator; can sense electricity in the water." },
                    { name: "Octopus", sciName: "Octopus vulgaris", customLatin: "Class: Cephalopoda", clue: "Master of disguise; has three hearts and blue blood." },
                    { name: "Seal", sciName: "Phoca vitulina", clue: "Pinniped 'sea dog'; hauls out on rocks to rest." },
                    { name: "Crab", sciName: "Callinectes sapidus", clue: "Decapod scavenger; walks sideways and wields pincers." }
                ]
            },
            {
                emoji: "üê†", name: "Fish",
                animals: [
                    { name: "Goldfish", sciName: "Carassius auratus", clue: "Carp descendant; selectively bred for centuries for color." },
                    { name: "Salmon", sciName: "Salmo salar", clue: "The Leaper; returns to its natal stream to spawn and die." },
                    { name: "Clownfish", sciName: "Amphiprion ocellaris", clue: "Anemone dweller; immune to the stings of its host." },
                    { name: "Seahorse", sciName: "Hippocampus guttulatus", clue: "Upright swimmer; the male carries the pregnancy." },
                    { name: "Piranha", sciName: "Pygocentrus nattereri", clue: "Amazonian shoaler; possesses interlocking teeth and a scary reputation." }
                ]
            },
            {
                emoji: "ü¶ã", name: "Insects+",
                animals: [
                    { name: "Butterfly", sciName: "Danaus plexippus", clue: "Migratory marvel; tastes with its feet and originated as a caterpillar." },
                    { name: "Bee", sciName: "Apis mellifera", clue: "Important pollinator that lives in hives and produces wax." },
                    { name: "Tarantula", sciName: "Brachypelma", clue: "Hairy arachnid; flicks urticating bristles when threatened." },
                    { name: "Scorpion", sciName: "Pandinus imperator", clue: "Fluorescent arachnid; carries a stinger on a segmented tail." },
                    { name: "Snail", sciName: "Cornu aspersum", clue: "Hermaphroditic grazer; carries its calcium house on its back." },
                    { name: "Mantis", sciName: "Mantis religiosa", customLatin: "Class: Insecta", clue: "Patient ambush predator; famous for sexual cannibalism." }
                ]
            }
        ];

        // --- HELPER: Flatten & Sort for "All Animals" ---
        const ALL_ANIMALS_FLAT = ANIMAL_GROUPS.reduce((acc, group) => {
            return acc.concat(group.animals.map(a => ({...a, group: group.name, groupEmoji: group.emoji})));
        }, []).sort((a, b) => a.name.localeCompare(b.name));

        // --- COMPONENT: MapClue (Updated for Dynamic Zoom) ---
        const MapClue = ({ lat, lng, zoom }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markerRef = useRef(null);
            const resizeObserverRef = useRef(null);

            useEffect(() => {
                if (mapRef.current && !mapInstanceRef.current) {
                    mapInstanceRef.current = L.map(mapRef.current, {
                        zoomControl: false, attributionControl: false, dragging: false,
                        scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false, 
                    }).setView([lat, lng], zoom);

                    L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}{r}.png', {
                        attribution: '&copy; OpenStreetMap &copy; CARTO',
                        maxZoom: 19
                    }).addTo(mapInstanceRef.current);

                    const icon = L.divIcon({
                        className: 'custom-pin', html: `<div></div>`,
                        iconSize: [20, 20], iconAnchor: [10, 10]
                    });

                    markerRef.current = L.marker([lat, lng], { icon }).addTo(mapInstanceRef.current);

                    resizeObserverRef.current = new ResizeObserver(() => {
                         if (mapInstanceRef.current) mapInstanceRef.current.invalidateSize();
                    });
                    resizeObserverRef.current.observe(mapRef.current);
                }
                return () => {
                    if (resizeObserverRef.current) resizeObserverRef.current.disconnect();
                };
            }, []);

            // React to props updates (Zooming in)
            useEffect(() => {
                if (mapInstanceRef.current && markerRef.current) {
                    mapInstanceRef.current.setView([lat, lng], zoom);
                    markerRef.current.setLatLng([lat, lng]);
                }
            }, [lat, lng, zoom]);

            return <div ref={mapRef} className="w-full h-full"></div>;
        };

        // --- HELPER: Filter Low Quality Records ---
        const isLowQualityRecord = (record) => {
            // 1. Strict JSON/Property Checks
            // We remove spaces to ensure we catch {"key":"value"} AND {"key": "value"}
            const dynProps = (record.dynamicProperties || "").toLowerCase().replace(/\s/g, "");
            
            if (dynProps.includes('"evidenceofpresence":"track"')) return true;
            if (dynProps.includes('"evidenceofpresence":"scat"')) return true;
            if (dynProps.includes('"evidenceofpresence":"bone"')) return true;
            if (dynProps.includes('"evidenceofpresence":"egg"')) return true; // <--- NEW CHECK
            if (dynProps.includes('"vitality":"dead"')) return true;

            // 2. Explicit Field Check (if API returns 'vitality' column)
            if (record.vitality && record.vitality.toLowerCase().includes("dead")) return true;

            // 3. General Keyword Sweep (The "Safety Net")
            const bannedKeywords = [
                "track", "print", "footprint", "paw", "scat", "feces", "dropping", "poop", "dung", "spoor",
                "burrow", "nest", "den", "moult", "shed", "dead", "roadkill", "dor", "carcass", "remains", 
                "bone", "skull", "skeleton", "corpse", "killed", "died", "road kill", "found dead",
                "egg", "clutch" // <--- Added to catch "clutch of eggs" descriptions
            ];
            
            const textFields = [
                record.occurrenceRemarks, 
                record.fieldNotes, 
                record.media?.[0]?.description, 
                record.media?.[0]?.title, 
                record.occurrenceStatus
            ].filter(Boolean).join(" ").toLowerCase();

            const hasBannedWord = bannedKeywords.some(keyword => textFields.includes(keyword));
            
            // 4. Sampling Protocol Check
            const protocol = (record.samplingProtocol || "").toLowerCase();
            const isTraceProtocol = protocol.includes("track") || protocol.includes("sign") || protocol.includes("scat");

            return hasBannedWord || isTraceProtocol;
        };

        // --- COMPONENT: CountdownScreen ---
        const CountdownScreen = ({ onComplete }) => {
            const [count, setCount] = useState(3);
            const [emoji, setEmoji] = useState("ü¶Å");
            const emojis = ["ü¶Å", "üêØ", "üêª", "üê®", "üêº", "üê∏", "üêô", "ü¶ä", "ü¶ì", "ü¶Ñ", "ü¶Ö", "üêù", "ü¶Ä", "ü¶ñ"];

            useEffect(() => {
                if (count === 0) { onComplete(); return; }
                const timer = setTimeout(() => setCount(c => c - 1), 1000);
                return () => clearTimeout(timer);
            }, [count, onComplete]);

            useEffect(() => {
                const interval = setInterval(() => {
                    setEmoji(emojis[Math.floor(Math.random() * emojis.length)]);
                }, 150);
                return () => clearInterval(interval);
            }, []);

            return (
                <div className="h-screen w-full flex flex-col items-center justify-center bg-emerald-900 text-white">
                    <h2 className="text-3xl font-bold mb-8 animate-pulse text-emerald-200">ARE YOU READY?</h2>
                    <div className="text-9xl mb-8 font-mono font-bold">{count > 0 ? count : "GO!"}</div>
                    <div className="text-6xl swap-anim">{emoji}</div>
                </div>
            );
        };

        // --- MAIN COMPONENT ---
        const WildGuessGame = () => {
            const [view, setView] = useState('menu');
            const [animalData, setAnimalData] = useState(null);
            const [preloadedData, setPreloadedData] = useState(null);
            const [currentClueIndex, setCurrentClueIndex] = useState(0);
            const [timeLeft, setTimeLeft] = useState(10);
            const [roundScore, setRoundScore] = useState(5);
            const [guessLocked, setGuessLocked] = useState(false);
            const [wrongGuesses, setWrongGuesses] = useState([]);
            const [gameResult, setGameResult] = useState(null);
            const [selectedGroup, setSelectedGroup] = useState(null); 
            const [showDebug, setShowDebug] = useState(false);
            const [gameId, setGameId] = useState(0);
            
            // Track used animals to prevent repeats
            const [usedAnimals, setUsedAnimals] = useState(new Set());
            const timerRef = useRef(null);

            useEffect(() => {
                preloadNextGame();
            }, []);



            const preloadNextGame = async () => {
                try {
                    const data = await fetchValidAnimal();
                    setPreloadedData(data);
                } catch (e) {
                    console.warn("Background fetch failed", e);
                }
            };

            const startGame = async () => {
                setWrongGuesses([]);
                setCurrentClueIndex(0);
                setRoundScore(5);
                setGuessLocked(false);
                setGameResult(null);
                setSelectedGroup(null);
                setGameId(prev => prev + 1);
                
                if (preloadedData) {
                    setAnimalData(preloadedData);
                    setPreloadedData(null); 
                    setView('countdown');
                } else {
                    setView('loading');
                    try {
                        const data = await fetchValidAnimal();
                        setAnimalData(data);
                        setView('countdown');
                    } catch (e) {
                        alert("Network error. Please try again.");
                        setView('menu');
                    }
                }
            };

            const onCountdownComplete = () => {
                setView('game');
                startTimeForClue();
                preloadNextGame();
            };

            // --- FIXED API FETCH (Licenses as separate params) ---
            const fetchValidAnimal = async (retryCount = 0) => {
                if (retryCount > 10) throw new Error("Game Init Failed");

                // 1. Pick a Random Animal (excluding used ones if possible)
                let availableAnimals = ALL_ANIMALS_FLAT.filter(a => !usedAnimals.has(a.name));
                if (availableAnimals.length === 0) {
                    availableAnimals = ALL_ANIMALS_FLAT;
                    setUsedAnimals(new Set());
                }
                const targetAnimal = availableAnimals[Math.floor(Math.random() * availableAnimals.length)];
                
                // 2. Strict API Query for iNaturalist Research-Grade (2025-2026)
                const endpoint = "https://api.gbif.org/v1/occurrence/search";
                const params = new URLSearchParams();
                
                params.append("scientificName", targetAnimal.sciName);
                params.append("datasetKey", "50c9509d-22c7-4a22-a47d-8c48425ef4a7"); // iNaturalist Research-Grade
                params.append("basisOfRecord", "HUMAN_OBSERVATION");
                params.append("hasCoordinate", "true");
                params.append("hasGeospatialIssue", "false");
                params.append("mediaType", "StillImage");
                params.append("occurrenceStatus", "PRESENT");
                
                // IMPORTANT FIX: Append licenses separately
                params.append("license", "CC_BY_4_0");
                params.append("license", "CC0_1_0");
                
                params.append("year", "2025,2026"); 
                params.append("limit", "20"); 

                try {
                    const response = await fetch(`${endpoint}?${params.toString()}`);
                    if (!response.ok) {
                        await new Promise(r => setTimeout(r, 500)); 
                        return fetchValidAnimal(retryCount + 1);
                    }

                    const json = await response.json();

                    if (!json.results || json.results.length === 0) {
                        return fetchValidAnimal(retryCount + 1);
                    }

                    const shuffledRecords = json.results.sort(() => 0.5 - Math.random());

                    for (const record of shuffledRecords) {
                        const image = record.media?.find(m => m.type === 'StillImage')?.identifier;
                        if (!image) continue;

                        if (isLowQualityRecord(record)) continue;

                        try {
                            await checkImageValidity(image);
                            setUsedAnimals(prev => new Set(prev).add(targetAnimal.name));
                            return processRecord(record, targetAnimal, image);
                        } catch (e) {
                            continue;
                        }
                    }

                    return fetchValidAnimal(retryCount + 1);

                } catch (e) {
                    return fetchValidAnimal(retryCount + 1);
                }
            };

            const checkImageValidity = (url) => {
                return new Promise((resolve, reject) => {
                    const img = new Image();
                    img.onload = () => resolve(true);
                    img.onerror = () => reject(false);
                    setTimeout(() => reject(false), 3000); 
                    img.src = url;
                });
            };

            const processRecord = (record, targetAnimal, image) => {
                // Location Logic: Combine State + Country, filtering out empties
                const country = record.country || "";
                const state = record.stateProvince || "";
                const locationParts = [state, country].filter(part => part && part.trim() !== "");
                const locationStr = locationParts.length > 0 ? locationParts.join(", ") : "Unknown Location";
                
                const family = record.family || "Unknown Family";
                const year = record.year || new Date(record.eventDate).getFullYear();
                
                const dateObj = new Date(record.eventDate);
                const dateStr = dateObj.toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' });

                // --- LOGIC: Use Custom Latin if defined (to hide obvious names like Gorilla) ---
                const displaySciName = targetAnimal.customLatin || record.scientificName;

                return {
                    correctGroupEmoji: targetAnimal.groupEmoji,
                    correctName: targetAnimal.name, 
                    sciName: displaySciName, // <--- Using the safe name here
                    family: family,
                    location: locationStr, 
                    lat: record.decimalLatitude,
                    lng: record.decimalLongitude,
                    image: image,
                    recordedBy: record.recordedBy || "Unknown Observer",
                    link: record.occurrenceID,
                    gbifID: record.gbifID,
                    stats: {
                        date: dateStr,
                        year: year,
                        trait: targetAnimal.clue 
                    },
                    raw: record
                };
            };

            const startTimeForClue = () => {
                setTimeLeft(10);
                if (timerRef.current) clearInterval(timerRef.current);
                timerRef.current = setInterval(() => {
                    setTimeLeft(prev => {
                        if (prev <= 1) {
                            advanceClue();
                            return 10;
                        }
                        return prev - 1;
                    });
                }, 1000);
            };

            const advanceClue = () => {
                setCurrentClueIndex(prev => {
                    if (prev >= 4) { endGame('loss'); return 4; }
                    setGuessLocked(false);
                    setRoundScore(score => Math.max(1, score - 1));
                    return prev + 1;
                });
            };

            const skipClue = () => {
                if (currentClueIndex < 4) {
                    setTimeLeft(10); 
                    advanceClue();
                }
            };

            const handleFinalGuess = (animalName) => {
                if (guessLocked || view !== 'game') return;
                if (animalName === animalData.correctName) {
                    endGame('win');
                } else {
                    setWrongGuesses(prev => [...prev, animalName]);
                    if (currentClueIndex === 4) { endGame('loss'); } 
                    else { setTimeLeft(10); advanceClue(); }
                }
            };

            const endGame = (result) => {
                clearInterval(timerRef.current);
                setGameResult(result);
                setView('summary');
            };

            if (view === 'menu') {
                return (
                    <div className="h-screen w-full flex flex-col items-center justify-center p-6 bg-emerald-900 text-white text-center">
                        <div className="text-6xl mb-4">üêæ</div>
                        <h1 className="text-4xl font-bold mb-2 font-mono">WILD GUESS</h1>
                        <h2 className="text-xl text-emerald-300 mb-6 tracking-widest uppercase text-xs">iNaturalist Edition</h2>
                        <p className="text-emerald-200 mb-8 max-w-md">Identify animals from recent research-grade observations (2025-2026).</p>
                        <button 
                            onClick={startGame}
                            className={`text-white font-bold py-4 px-10 rounded-full shadow-lg transform transition hover:scale-105 ${preloadedData ? 'bg-emerald-500 hover:bg-emerald-400' : 'bg-emerald-600 cursor-wait opacity-80'}`}
                        >
                            {preloadedData ? "START HUNT" : "LOADING..."}
                        </button>
                    </div>
                );
            }

            if (view === 'loading') return <div className="h-screen w-full flex flex-col items-center justify-center bg-slate-100"><div className="animate-spin text-4xl mb-4">üåç</div><h2 className="text-xl font-bold text-slate-700">Connecting to GBIF...</h2></div>;
            
            if (view === 'countdown') return <CountdownScreen onComplete={onCountdownComplete} />;

            return (
                <div className="h-screen w-full flex flex-col md:flex-row bg-slate-100 overflow-hidden relative">
                    
                    {/* DEBUG CONSOLE (Hidden by default, type 'devmode') */}
                    {showDebug && (
                        <div className="absolute top-12 left-2 z-50 w-80 max-h-[80vh] bg-black/90 text-green-400 p-4 rounded-lg overflow-y-auto text-xs font-mono shadow-xl border border-green-800">
                            <h3 className="font-bold text-white mb-2 border-b border-gray-700 pb-1">Debug Console</h3>
                            <pre className="whitespace-pre-wrap">{JSON.stringify(animalData, null, 2)}</pre>
                        </div>
                    )}

                    <div className="flex-1 flex flex-col bg-white m-2 rounded-xl shadow-sm overflow-hidden relative order-1">
                        <div className="h-2 bg-slate-200 w-full flex-shrink-0"><div className="h-full bg-emerald-500 transition-all duration-1000 linear" style={{ width: `${(timeLeft / 10) * 100}%` }}></div></div>
                        <div className="flex-1 relative">
                            
                            {/* --- MAP LAYER --- */}
                            <div className="absolute inset-0" key={gameId}>
                                <div className={`absolute inset-0 transition-opacity duration-500 ${currentClueIndex >= 0 ? 'opacity-100' : 'opacity-0'}`}>
                                    {/* CLUE 1 & 2: Dynamic Zoom */}
                                    {animalData && <MapClue lat={animalData.lat} lng={animalData.lng} zoom={currentClueIndex === 0 ? 2 : 5} />}
                                    
                                    {/* GRADIENT REMOVED HERE */}
                                
                                </div>
                                <div className={`absolute inset-0 z-10 transition-opacity duration-1000 bg-slate-200 ${currentClueIndex >= 4 ? 'opacity-100' : 'opacity-0 pointer-events-none'}`}>
                                    {/* CLUE 5: Photo Reveal */}
                                    {animalData?.image && (<div className="w-full h-full relative"><img src={animalData.image} className="w-full h-full object-cover" alt="Revealed Animal" /><div className="absolute inset-0 bg-black/10"></div></div>)}
                                </div>
                            </div>

                            {/* --- HEADER SECTION --- */}
                            <div className="absolute top-0 left-0 right-0 z-30 pt-6 text-center pointer-events-none">
                                {/* Increased drop-shadow heavily so text is readable without gradient */}
                                <h2 className="text-3xl md:text-4xl font-black text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.9)] tracking-tight uppercase leading-none">
                                    Take a <span className="text-emerald-400">Wild Guess</span>
                                </h2>
                                <p className="text-white text-sm font-bold mt-1 drop-shadow-[0_1px_2px_rgba(0,0,0,0.9)] uppercase tracking-widest">Can you identify this animal?</p>
                            </div>
                            
                            {/* --- CLUES SECTION (Moved to Top) --- */}
                            <div className="absolute inset-0 top-24 p-4 flex flex-col items-center justify-start pointer-events-none overflow-y-auto clue-scroll z-20 space-y-2">
                                
                                {/* CLUE 2: Location Text */}
                                <div className={`transition-all duration-500 transform ${currentClueIndex >= 1 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'}`}>
                                    <div className="bg-white/90 backdrop-blur-md px-4 py-2 rounded-lg shadow-xl border border-white/50">
                                        <span className="text-[10px] font-bold text-slate-400 uppercase block text-center tracking-wider">Location</span>
                                        <span className="text-slate-800 font-bold text-lg leading-tight block">{animalData?.location}</span>
                                    </div>
                                </div>

                                {/* CLUE 3: Family & Scientific Name */}
                                <div className={`transition-all duration-500 transform ${currentClueIndex >= 2 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'}`}>
                                    <div className="bg-white/90 backdrop-blur-md px-6 py-3 rounded-lg shadow-xl border border-white/50 text-center min-w-[220px]">
                                        <div className="mb-2">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase block tracking-wider">Family</span>
                                            <span className="text-indigo-600 font-mono font-bold text-lg leading-none">{animalData?.family}</span>
                                        </div>
                                        <div className="border-t border-slate-200/50 pt-2">
                                            <span className="text-[10px] font-bold text-slate-400 uppercase block tracking-wider">Scientific Name</span>
                                            <span className="text-emerald-800 italic font-serif text-xl leading-none">{animalData?.sciName}</span>
                                        </div>
                                    </div>
                                </div>

                                {/* CLUE 4: Vague Description */}
                                <div className={`transition-all duration-500 transform ${currentClueIndex >= 3 ? 'translate-y-0 opacity-100' : '-translate-y-4 opacity-0'}`}>
                                    <div className="bg-emerald-50/95 backdrop-blur-md px-5 py-3 rounded-lg shadow-xl border border-emerald-100 max-w-sm text-center">
                                        <span className="text-[10px] font-bold text-emerald-600 uppercase block mb-1 tracking-wider">Hint</span>
                                        <div className="text-emerald-900 font-medium italic text-lg leading-snug">"{animalData?.stats?.trait}"</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div className="h-14 bg-white border-t border-slate-100 flex items-center justify-between px-4 z-10 flex-shrink-0">
                            <div className="text-slate-500 font-mono text-sm">PTS: <span className="text-emerald-600 font-bold">{roundScore}</span></div>
                            <div className="flex gap-2">
                                <button onClick={() => endGame('surrender')} className="px-3 py-1 text-xs text-slate-400 hover:text-red-500 font-medium">GIVE UP</button>
                                <button onClick={skipClue} className="bg-blue-50 text-blue-600 px-4 py-1 rounded-full text-xs font-bold hover:bg-blue-100 transition">NEXT CLUE</button>
                            </div>
                        </div>
                    </div>

                    <div className="h-1/2 md:h-full md:w-96 bg-slate-50 p-2 overflow-hidden border-t md:border-t-0 md:border-l border-slate-200 order-2 flex flex-col">
                        
                        {/* CATEGORY SELECTION VIEW */}
                        {!selectedGroup && (
                            <div className="grid grid-cols-4 gap-2 overflow-y-auto custom-scroll p-1">
                                {/* 1. The "All Animals" Button */}
                                <button
                                    onClick={() => setSelectedGroup("ALL")}
                                    disabled={guessLocked}
                                    className={`
                                        aspect-square rounded-xl flex flex-col items-center justify-center transition-all duration-200 shadow-sm
                                        bg-slate-800 text-white hover:bg-slate-700 hover:shadow-md cursor-pointer border border-slate-700
                                        ${guessLocked ? 'opacity-50' : ''}
                                    `}
                                >
                                    <span className="text-2xl mb-1">üåé</span>
                                    <span className="text-[10px] font-bold uppercase tracking-tight">All Animals</span>
                                </button>

                                {/* 2. The Standard Categories */}
                                {ANIMAL_GROUPS.map((group, idx) => (
                                    <button
                                        key={idx}
                                        disabled={guessLocked}
                                        onClick={() => setSelectedGroup(group)}
                                        className={`
                                            aspect-square rounded-xl flex flex-col items-center justify-center transition-all duration-200 shadow-sm
                                            bg-white hover:bg-emerald-50 hover:shadow-md cursor-pointer border border-slate-100
                                            ${guessLocked ? 'opacity-50' : ''}
                                        `}
                                    >
                                        <span className="text-3xl mb-1">{group.emoji}</span>
                                        <span className="text-[10px] text-slate-500 font-bold uppercase tracking-tight">{group.name}</span>
                                    </button>
                                ))}
                            </div>
                        )}

                        {/* ANIMAL LIST VIEW */}
                        {selectedGroup && (
                            <div className="flex flex-col h-full">
                                <button 
                                    onClick={() => setSelectedGroup(null)}
                                    className="mb-2 flex items-center text-slate-500 hover:text-emerald-600 text-sm font-bold px-2 py-1"
                                >
                                    ‚Üê Back to Categories
                                </button>
                                
                                <div className="text-center mb-2">
                                    <span className="text-3xl inline-block mr-2">{selectedGroup === "ALL" ? "üåé" : selectedGroup.emoji}</span>
                                    <span className="text-lg font-bold text-slate-700">{selectedGroup === "ALL" ? "All Animals" : selectedGroup.name}</span>
                                </div>

                                {/* CONDITIONAL GRID: 3 Columns for "ALL", 2 Columns for specific groups */}
                                <div className={`grid gap-2 overflow-y-auto custom-scroll p-1 flex-1 content-start ${selectedGroup === "ALL" ? 'grid-cols-3' : 'grid-cols-2'}`}>
                                    {(selectedGroup === "ALL" ? ALL_ANIMALS_FLAT : selectedGroup.animals).map((animal, idx) => {
                                        const isWrong = wrongGuesses.includes(animal.name);
                                        return (
                                            <button
                                                key={idx}
                                                disabled={guessLocked || isWrong}
                                                onClick={() => handleFinalGuess(animal.name)}
                                                className={`
                                                    rounded-lg font-bold shadow-sm border border-slate-100 transition-all leading-tight
                                                    ${selectedGroup === "ALL" ? 'py-2 px-1 text-[10px] h-12' : 'py-3 px-2 text-sm'}
                                                    ${isWrong 
                                                        ? 'bg-red-50 text-red-300 border-red-100 cursor-not-allowed' 
                                                        : 'bg-white text-slate-700 hover:bg-emerald-50 hover:text-emerald-700 hover:border-emerald-200'}
                                                    ${guessLocked ? 'opacity-50' : ''}
                                                `}
                                            >
                                                {animal.name}
                                            </button>
                                        )
                                    })}
                                </div>
                            </div>
                        )}
                    </div>

                    {view === 'summary' && (
                        <div className="absolute inset-0 z-50 bg-black/80 backdrop-blur-sm flex items-center justify-center p-4">
                            <div className="bg-white rounded-2xl w-full max-w-sm overflow-hidden shadow-2xl animate-pop flex flex-col max-h-[90vh]">
                                <div className="h-64 bg-slate-200 relative flex-shrink-0">
                                    {animalData?.image ? (<img src={animalData.image} className="w-full h-full object-cover" alt="Animal" />) : (<div className="w-full h-full flex items-center justify-center text-slate-400">No Image</div>)}
                                    <div className="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/80 to-transparent p-4 pt-12">
                                        <h2 className="text-white text-3xl font-bold leading-none">{animalData?.correctName}</h2>
                                        <p className="text-white/80 text-sm italic font-serif mt-1">{animalData?.sciName}</p>
                                    </div>
                                </div>
                                <div className="p-6 text-center flex-1 overflow-y-auto custom-scroll">
                                    {gameResult === 'win' ? (
                                        <div className="mb-6"><div className="text-5xl mb-2 animate-bounce">üéâ</div><h3 className="text-2xl font-bold text-emerald-600 mb-1">Correct!</h3><p className="text-slate-600 font-medium">You earned <span className="text-emerald-600 font-bold">{roundScore} points</span>.</p></div>
                                    ) : (
                                        <div className="mb-6"><div className="text-5xl mb-2">‚ò†Ô∏è</div><h3 className="text-2xl font-bold text-red-600 mb-1">Missed it!</h3><p className="text-slate-600">Better luck next time.</p></div>
                                    )}
                                    <div className="bg-slate-50 rounded-xl p-4 text-left space-y-3 text-sm border border-slate-100 shadow-inner">
                                        <div className="flex justify-between border-b border-slate-200 pb-2">
                                            <span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Observed By</span>
                                            {/* Hyperlink Logic */}
                                            {animalData?.link ? (
                                                <a 
                                                    href={animalData.link} 
                                                    target="_blank" 
                                                    rel="noopener noreferrer"
                                                    className="text-emerald-600 font-medium hover:underline truncate max-w-[150px]"
                                                >
                                                    {animalData.recordedBy} ‚Üó
                                                </a>
                                            ) : (
                                                <span className="text-slate-700 font-medium">{animalData?.recordedBy}</span>
                                            )}
                                        </div>
                                        <div className="flex justify-between border-b border-slate-200 pb-2"><span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Date</span><span className="text-slate-700 font-medium">{animalData?.stats?.date}</span></div>
                                        <div className="flex justify-between border-b border-slate-200 pb-2"><span className="text-slate-400 font-bold uppercase text-xs tracking-wider">Location</span><span className="text-slate-700 text-right max-w-[60%] font-medium">{animalData?.location}</span></div>
                                        
                                        {/* --- UPDATED CITATION FOOTER --- */}
                                        <div className="pt-2 text-center border-t border-slate-200 mt-2">
                                            <p className="text-[10px] text-slate-400 leading-tight">
                                                Data source: <a href="https://doi.org/10.15468/ab3s5x" target="_blank" className="underline hover:text-emerald-500">iNaturalist Research-grade Observations</a>
                                                <br/>
                                                accessed via GBIF.org
                                            </p>
                                        </div>
                                    </div>
                                </div>
                                <div className="p-4 bg-white border-t border-slate-100 flex-shrink-0">
                                    <button onClick={startGame} className="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-4 rounded-xl transition shadow-lg shadow-emerald-200 transform hover:scale-[1.02]">PLAY AGAIN</button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<WildGuessGame />);
    </script>
</body>
</html>